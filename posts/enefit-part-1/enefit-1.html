<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sameer Sant">
<meta name="dcterms.date" content="2024-06-04">

<title>Sameer Sant - Enefit - Predict Energy Behavior of Prosumers, part 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Sameer Sant</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sksant"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Enefit - Predict Energy Behavior of Prosumers, part 1</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">technical</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Sameer Sant </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 4, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#defining-a-validation-set" id="toc-defining-a-validation-set" class="nav-link active" data-scroll-target="#defining-a-validation-set"><span class="header-section-number">1</span> Defining a validation set</a></li>
  <li><a href="#understanding-forecasts" id="toc-understanding-forecasts" class="nav-link" data-scroll-target="#understanding-forecasts"><span class="header-section-number">2</span> Understanding forecasts</a></li>
  <li><a href="#merging-the-tables" id="toc-merging-the-tables" class="nav-link" data-scroll-target="#merging-the-tables"><span class="header-section-number">3</span> Merging the tables</a></li>
  <li><a href="#cleaning-the-data" id="toc-cleaning-the-data" class="nav-link" data-scroll-target="#cleaning-the-data"><span class="header-section-number">4</span> Cleaning the data</a></li>
  <li><a href="#modeling-with-trees" id="toc-modeling-with-trees" class="nav-link" data-scroll-target="#modeling-with-trees"><span class="header-section-number">5</span> Modeling with trees</a></li>
  <li><a href="#partial-dependence-analysis" id="toc-partial-dependence-analysis" class="nav-link" data-scroll-target="#partial-dependence-analysis"><span class="header-section-number">6</span> Partial dependence analysis</a></li>
  <li><a href="#out-of-domain-analysis" id="toc-out-of-domain-analysis" class="nav-link" data-scroll-target="#out-of-domain-analysis"><span class="header-section-number">7</span> Out-of-Domain analysis</a></li>
  <li><a href="#tree-interpreter" id="toc-tree-interpreter" class="nav-link" data-scroll-target="#tree-interpreter"><span class="header-section-number">8</span> Tree interpreter</a></li>
  <li><a href="#modeling-with-a-neural-network" id="toc-modeling-with-a-neural-network" class="nav-link" data-scroll-target="#modeling-with-a-neural-network"><span class="header-section-number">9</span> Modeling with a neural network</a></li>
  <li><a href="#ensembling" id="toc-ensembling" class="nav-link" data-scroll-target="#ensembling"><span class="header-section-number">10</span> Ensembling</a></li>
  <li><a href="#entity-embeddings-in-a-random-forest" id="toc-entity-embeddings-in-a-random-forest" class="nav-link" data-scroll-target="#entity-embeddings-in-a-random-forest"><span class="header-section-number">11</span> Entity embeddings in a random forest</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">12</span> Next steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><img src="image.jpg" class="img-fluid"></p>
<p>I completed part 1 of <a href="https://www.fast.ai/about.html#jeremy-howard">Jeremy Howard</a>’s course <a href="https://course.fast.ai/">Practical Deep Learning for Coders</a>. To practice what I learned about modeling tabular data, I competed in a recent time series <a href="https://www.kaggle.com/competitions/predict-energy-behavior-of-prosumers">forecasting competition</a> on Kaggle.</p>
<p><a href="https://www.enefit.ee/en/enefit">Enefit</a>, one of the largest energy companies in the Baltic region, challenged competitors to create an energy prediction model of Estonian clients that have installed solar panels. Because these “prosumers” both produce and consume energy, they disproportionately create energy imbalance, where expected consumption doesn’t match actual consumption. For Enefit, the result is inefficiency, higher operational costs, and grid instability. Since prosumers are a rapidly increasing share of energy clients, reliable energy predictions are critical.</p>
<p>Specifically, our prediction target is the amount produced or consumed by a prosumer given recent records of actual targets, installed capacity, weather data, and relevant energy prices. A standard modeling process would entail an in-depth exploratory analysis followed by building a model. Instead, Jeremy recommends to:</p>
<ol type="1">
<li><p>build a model early on that is easy to train and interpret, like a decision tree;</p></li>
<li><p>use the model to better understand the data, i.e.&nbsp;identify data issues, find out what’s hard, what features are the strongest predictors, how they vary with the target, etc;</p></li>
<li><p>iterate rapidly to improve the data and the model.</p></li>
</ol>
<p>In this post, I’ll walk through these steps for my solution. But first, let’s define a validation set.</p>
<section id="defining-a-validation-set" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="defining-a-validation-set"><span class="header-section-number">1</span> Defining a validation set</h2>
<div id="ffba9e88-b2d0-40c5-a6a8-1501d40602c6" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> [ <span class="op">-</span>e <span class="op">/</span>content ] <span class="op">&amp;&amp;</span> pip install <span class="op">-</span>Uqq fastbook kaggle waterfallcharts treeinterpreter dtreeviz holidays</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastbook</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>fastbook.setup_book()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="0aa29559-4c8b-4ef6-b912-cc8f8e45b5fc" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastbook <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.api.types <span class="im">import</span> is_string_dtype, is_numeric_dtype, is_categorical_dtype</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeRegressor</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dtreeviz.trees <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image, display_svg, SVG</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> holidays</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_rows <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_columns <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">'ignore'</span>, <span class="pp">FutureWarning</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">'ignore'</span>, <span class="pp">RuntimeWarning</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">'ignore'</span>, <span class="pp">UserWarning</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The released data covers September 1, 2021 to May 29, 2023. During the evaluation period, the models are re-scored 3 times as new data is collected: over February 2024, March 2024, and finally April 2024.</p>
<p>An effective validation set should resemble the test data, which is what the model is ultimately scored on. Since our goal is to forecast, the test data will be more recent than the released data. It’s also given that new prosumers can appear or disappear each successive scoring period. Therefore, not only must the validation data be more recent than the training data, it must also include prosumers that are not in the training data.</p>
<p>For my final solution, I performed 3-fold cross validation using progressively larger training sets and 1 month validation sets that aligned with the scoring periods: February 2023, March 2023, and April 2023. Each round, I dropped a random set of prosumers from the training set among those common to training and validation just after the split, which made the validation ones new from the model’s point of view. In subsequent rounds, I included the validation month from the previous round in the training set. I then averaged the errors over the three rounds to get a cross validation score. I held out May 2023 as my test set. This is summarized below:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">Round</th>
<th style="text-align: right;">Train</th>
<th style="text-align: right;">Valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">Sept 2021 - Jan 2023</td>
<td style="text-align: right;">Feb 2023</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">Sept 2021 - Feb 2023</td>
<td style="text-align: right;">Mar 2023</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">Sept 2021 - Mar 2023</td>
<td style="text-align: right;">Apr 2023</td>
</tr>
<tr class="even">
<td style="text-align: right;">Test</td>
<td style="text-align: right;">Sept 2021 - Apr 2023</td>
<td style="text-align: right;">May 2023</td>
</tr>
</tbody>
</table>
<p>I used Round 1’s scheme during my development process. Let’s look at the data available at forecast time next.</p>
</section>
<section id="understanding-forecasts" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="understanding-forecasts"><span class="header-section-number">2</span> Understanding forecasts</h2>
<div id="74393736-c3be-49cf-9a3b-893d78503c36" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>URLs.LOCAL_PATH <span class="op">=</span> Path(<span class="st">'/notebooks/kaggle/enefit'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> URLs.LOCAL_PATH<span class="op">/</span><span class="st">'predict-energy-behavior-of-prosumers'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># prosumer details</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'test.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>revealed_targets_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'revealed_targets.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>t_client_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'client.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># weather tables</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>t_forecast_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'forecast_weather.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>t_historical_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'historical_weather.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># relevant energy prices</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>t_electricity_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'electricity_prices.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>t_gas_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'example_test_files'</span><span class="op">/</span><span class="st">'gas_prices.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># location</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>weather_station_to_county_mapping_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'weather_station_to_county_mapping.csv'</span>, low_memory<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2d395fb3-4e52-4256-892f-ddb4521e6703" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>t_dfs <span class="op">=</span> [test_df, revealed_targets_df, t_client_df, t_forecast_df, t_historical_df, t_electricity_df, t_gas_df, weather_station_to_county_mapping_df]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>t_df_names <span class="op">=</span> [<span class="st">'test'</span>, <span class="st">'revealed_targets'</span>, <span class="st">'client'</span>, <span class="st">'forecast_weather'</span>, <span class="st">'historical_weather'</span>, <span class="st">'electricity_prices'</span>, <span class="st">'gas_prices'</span>, <span class="st">'weather_station_to_county_mapping'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below is an overview of the columns containing prosumer details:</p>
<div id="1e52285d-c66d-4af2-9d38-3bee9cfff7ef" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>{k:v.columns <span class="cf">for</span> (k,v) <span class="kw">in</span> <span class="bu">zip</span>(t_df_names[:<span class="dv">3</span>], t_dfs[:<span class="dv">3</span>])}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>{'test': Index(['county', 'is_business', 'product_type', 'is_consumption',
        'prediction_datetime', 'data_block_id', 'row_id', 'prediction_unit_id',
        'currently_scored'],
       dtype='object'),
 'revealed_targets': Index(['county', 'is_business', 'product_type', 'target', 'is_consumption',
        'datetime', 'data_block_id', 'row_id', 'prediction_unit_id'],
       dtype='object'),
 'client': Index(['product_type', 'county', 'eic_count', 'installed_capacity',
        'is_business', 'date', 'data_block_id'],
       dtype='object')}</code></pre>
</div>
</div>
<p>The key fields in <code>test</code> are:</p>
<ul>
<li><code>county</code>: an ID for the county</li>
<li><code>is_business</code>: a boolean for whether the prosumer is a business</li>
<li><code>product_type</code>: an ID for the energy contract type, which maps as <code>{0: "Combined", 1: "Fixed", 2: "General service", 3: "Spot"}</code></li>
<li><code>is_consumption</code>: a boolean for whether the prediction is for consumption or production</li>
<li><code>prediction_datetime</code>: in Estonian time in EET (UTC+2) EEST (UTC+3), the start of the 1-hour period for which the target is to be forecast</li>
<li><code>prediction_unit_id</code>: an ID for the prosumer “segment”, i.e.&nbsp;the combination of <code>county</code>, <code>is_business</code>, and <code>product_type</code>, that Enefit uses to define each prosumer.</li>
<li><code>data_block_id</code>: an ID that indicates when the data is available.</li>
</ul>
<p>This competition uses a time series API that ensures the model sees only data that would actually be available for each forecast. According to the <a href="https://www.kaggle.com/competitions/predict-energy-behavior-of-prosumers/data">data dictionary</a>, the <code>data_block_id</code> column is present in all tables and indicates the available data; rows with the same <code>data_block_id</code> participate in the same forecast.</p>
<p>The API gets these rows across all tables and serves them as a group (a data block). Once a forecast is made, the process is repeated for the next <code>data_block_id</code>. We are also allowed to store incoming data for the current forecast and use it in future forecasts as lagged features.</p>
<p>All forecasts are made at 11am each day for each hour (12am-11pm) the next day. For example, let’s say today is <strong>2023-05-30</strong>. At 11am today, the API gets rows from:</p>
<ul>
<li><code>test</code>: tomorrow’s datetimes (<strong>2023-05-31</strong> 00:00:00 to <strong>2023-05-31</strong> 23:00:00). This is the current forecast horizon.</li>
</ul>
<div id="7b8db97b-63f9-4e87-baf9-4df1aa41218e" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>test_df[test_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">prediction_datetime</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
<th data-quarto-table-cell-role="th">row_id</th>
<th data-quarto-table-cell-role="th">prediction_unit_id</th>
<th data-quarto-table-cell-role="th">currently_scored</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">9360</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>2023-05-31 00:00:00</td>
<td>637</td>
<td>2015232</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9361</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>2023-05-31 00:00:00</td>
<td>637</td>
<td>2015233</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9362</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>2023-05-31 00:00:00</td>
<td>637</td>
<td>2015234</td>
<td>1</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<ul>
<li><code>revealed_targets</code>: yesterday’s actual targets (<strong>2023-05-29</strong> 00:00:00 to <strong>2023-05-29</strong> 23:00:00). These datetimes lag 2 days behind the forecast horizon.</li>
</ul>
<div id="839ea812-2ee2-4949-84a0-6bcf70189a59" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>revealed_targets_df[revealed_targets_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">datetime</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
<th data-quarto-table-cell-role="th">row_id</th>
<th data-quarto-table-cell-role="th">prediction_unit_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">9456</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2.073</td>
<td>0</td>
<td>2023-05-29 00:00:00</td>
<td>637</td>
<td>2008992</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9457</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>503.735</td>
<td>1</td>
<td>2023-05-29 00:00:00</td>
<td>637</td>
<td>2008993</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9458</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0.000</td>
<td>0</td>
<td>2023-05-29 00:00:00</td>
<td>637</td>
<td>2008994</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<ul>
<li><code>client</code>: yesterday’s records of installed capacity (<strong>2023-05-29</strong>). These dates lag 2 days behind the forecast horizon.</li>
</ul>
<div id="3812c15d-04b6-4990-bb0e-99dc4918420d" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>t_client_df[t_client_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">eic_count</th>
<th data-quarto-table-cell-role="th">installed_capacity</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">197</td>
<td>1</td>
<td>0</td>
<td>508</td>
<td>4964.215</td>
<td>0</td>
<td>2023-05-29</td>
<td>637</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">198</td>
<td>2</td>
<td>0</td>
<td>10</td>
<td>31.000</td>
<td>0</td>
<td>2023-05-29</td>
<td>637</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">199</td>
<td>3</td>
<td>0</td>
<td>1515</td>
<td>15963.060</td>
<td>0</td>
<td>2023-05-29</td>
<td>637</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<ul>
<li><code>forecast_weather</code>: forecasted weather applicable from 3am today to 2am the day after tomorrow (<strong>2023-05-30</strong> 3:00:00 to <strong>2023-06-01</strong> 2:00:00) at the given coordinates. These datetimes include the current forecast horizon.</li>
</ul>
<div id="f8542a77-0591-4489-aed2-eeda98640c1e" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>t_forecast_df[t_forecast_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">origin_datetime</th>
<th data-quarto-table-cell-role="th">hours_ahead</th>
<th data-quarto-table-cell-role="th">temperature</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">forecast_datetime</th>
<th data-quarto-table-cell-role="th">direct_solar_radiation</th>
<th data-quarto-table-cell-role="th">surface_solar_radiation_downwards</th>
<th data-quarto-table-cell-role="th">snowfall</th>
<th data-quarto-table-cell-role="th">total_precipitation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">16128</td>
<td>57.6</td>
<td>21.7</td>
<td>2023-05-30 02:00:00</td>
<td>1</td>
<td>10.190088</td>
<td>...</td>
<td>2023-05-30 03:00:00</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16129</td>
<td>57.6</td>
<td>22.2</td>
<td>2023-05-30 02:00:00</td>
<td>1</td>
<td>6.493555</td>
<td>...</td>
<td>2023-05-30 03:00:00</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16130</td>
<td>57.6</td>
<td>22.7</td>
<td>2023-05-30 02:00:00</td>
<td>1</td>
<td>10.304346</td>
<td>...</td>
<td>2023-05-30 03:00:00</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>3 rows × 18 columns</p>
</div>
</div>
</div>
</div>
<ul>
<li><code>historical_weather</code>: historical weather from 11am yesterday to 1 hour ago (<strong>2023-05-29</strong> 11:00:00 to <strong>2023-05-30 10:00:00</strong>) at the given weather station coordinates. These datetimes lag at least 1 day behind the forecast horizon.</li>
</ul>
<div id="15019ce1-076b-4773-bee7-4641b6f061fc" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>t_historical_df[t_historical_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">datetime</th>
<th data-quarto-table-cell-role="th">temperature</th>
<th data-quarto-table-cell-role="th">dewpoint</th>
<th data-quarto-table-cell-role="th">rain</th>
<th data-quarto-table-cell-role="th">snowfall</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">direct_solar_radiation</th>
<th data-quarto-table-cell-role="th">diffuse_radiation</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8064</td>
<td>2023-05-29 11:00:00</td>
<td>15.0</td>
<td>10.0</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>489.0</td>
<td>129.0</td>
<td>57.6</td>
<td>21.7</td>
<td>637.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8065</td>
<td>2023-05-29 11:00:00</td>
<td>14.7</td>
<td>9.4</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>456.0</td>
<td>161.0</td>
<td>57.6</td>
<td>22.2</td>
<td>637.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8066</td>
<td>2023-05-29 11:00:00</td>
<td>14.3</td>
<td>9.8</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>408.0</td>
<td>197.0</td>
<td>57.6</td>
<td>22.7</td>
<td>637.0</td>
</tr>
</tbody>
</table>

<p>3 rows × 18 columns</p>
</div>
</div>
</div>
</div>
<ul>
<li><code>electricity_prices</code>: day-ahead electricity prices obtained yesterday, but applicable 12am-11pm today (<strong>2023-05-30</strong> 00:00:00 to <strong>2023-05-30</strong> 23:00:00). These datetimes lag 1 day behind the forecast horizon.</li>
</ul>
<div id="a1aedd1c-8c37-4edd-a816-118f8419d8ac" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>t_electricity_df[t_electricity_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">forecast_date</th>
<th data-quarto-table-cell-role="th">euros_per_mwh</th>
<th data-quarto-table-cell-role="th">origin_date</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">72</td>
<td>2023-05-30 00:00:00</td>
<td>8.57</td>
<td>2023-05-29 00:00:00</td>
<td>637</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">73</td>
<td>2023-05-30 01:00:00</td>
<td>8.06</td>
<td>2023-05-29 01:00:00</td>
<td>637</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">74</td>
<td>2023-05-30 02:00:00</td>
<td>9.04</td>
<td>2023-05-29 02:00:00</td>
<td>637</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<ul>
<li><code>gas_prices</code>: day-ahead gas prices obtained yesterday, but applicable today (<strong>2023-05-30</strong>). These dates lag 1 day behind the forecast horizon.</li>
</ul>
<div id="1dd23a2c-0263-40af-a99a-bc9ae196fa7b" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>t_gas_df[t_gas_df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">forecast_date</th>
<th data-quarto-table-cell-role="th">lowest_price_per_mwh</th>
<th data-quarto-table-cell-role="th">highest_price_per_mwh</th>
<th data-quarto-table-cell-role="th">origin_date</th>
<th data-quarto-table-cell-role="th">data_block_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>2023-05-30</td>
<td>29.0</td>
<td>34.0</td>
<td>2023-05-29</td>
<td>637</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Next, we’ll see how to merge this data.</p>
</section>
<section id="merging-the-tables" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="merging-the-tables"><span class="header-section-number">3</span> Merging the tables</h2>
<p>Since <code>test</code> contains the segments and the datetimes for which we are making forecasts, we want to keep all of the records in <code>test</code> and add matching records from the other tables to it. A left join will achieve this.</p>
<p>Here are the date ranges in our example data block:</p>
<div id="c57c791e-4b40-43cc-bd47-889003787782" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>date_col_names <span class="op">=</span> [<span class="st">'prediction_datetime'</span>, <span class="st">'datetime'</span>, <span class="st">'date'</span>, <span class="st">'forecast_datetime'</span>, <span class="st">'datetime'</span>, <span class="st">'forecast_date'</span>, <span class="st">'forecast_date'</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>date_cols <span class="op">=</span> [df.loc[df[<span class="st">'data_block_id'</span>] <span class="op">==</span> <span class="dv">637</span>, date_col_names[i]] <span class="cf">for</span> i,df <span class="kw">in</span> <span class="bu">enumerate</span>(t_dfs[:<span class="op">-</span><span class="dv">1</span>])]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>date_ranges <span class="op">=</span> [(t_df_names[i], date_cols[i].<span class="bu">min</span>(), date_cols[i].<span class="bu">max</span>()) <span class="cf">for</span> i,df <span class="kw">in</span> <span class="bu">enumerate</span>(t_dfs[:<span class="op">-</span><span class="dv">1</span>])]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>date_ranges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[('test', '2023-05-31 00:00:00', '2023-05-31 23:00:00'),
 ('revealed_targets', '2023-05-29 00:00:00', '2023-05-29 23:00:00'),
 ('client', '2023-05-29', '2023-05-29'),
 ('forecast_weather', '2023-05-30 03:00:00', '2023-06-01 02:00:00'),
 ('historical_weather', '2023-05-29 11:00:00', '2023-05-30 10:00:00'),
 ('electricity_prices', '2023-05-30 00:00:00', '2023-05-30 23:00:00'),
 ('gas_prices', '2023-05-30', '2023-05-30')]</code></pre>
</div>
</div>
<p>We can visualize them in the figure below. To align <code>revealed_targets</code>, <code>client</code>, <code>historical_weather</code>, <code>electricity_prices</code>, and <code>gas_prices</code>, we simply add back how much the respective datetimes lag those in <code>test</code> using a <a href="https://docs.python.org/3/library/datetime.html#timedelta-objects">timedelta</a>, effectively moving them up as lagged features. Note that we’ll have <code>historical_weather</code> from 12am-10am only as a result, shown in yellow.</p>
<p><code>forecast_weather</code> includes all of <code>test</code>’s datetimes, so we’ll just filter them by the <code>hours_ahead</code> column (meaning hours ahead of the forecast origin), i.e.&nbsp;hours ahead &gt;= 22 and &lt;= 45, shown in green.</p>
<p><img src="enefit-1_files/figure-html/5c5dacc1-334d-4b23-91dd-82aeff244b18-1-c01b25d4-2cc6-4a8a-b693-ce8a83ab0c38.png" class="img-fluid"></p>
<p>With the datetimes aligned, all but the weather tables are ready to be merged.</p>
<p>Both weather tables include latitude/longitude coordinates, but not a county ID as in test. Fortunately, we’re provided a <code>weather_station_to_county_mapping</code> table to do just that:</p>
<div id="1ebe8f13-8923-463f-91e6-765a931b657e" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>weather_station_to_county_mapping_df[<span class="op">~</span>weather_station_to_county_mapping_df[<span class="st">'county'</span>].isna()].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county_name</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">county</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Saaremaa</td>
<td>22.2</td>
<td>58.2</td>
<td>10.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Saaremaa</td>
<td>22.2</td>
<td>58.5</td>
<td>10.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19</td>
<td>Saaremaa</td>
<td>22.7</td>
<td>58.5</td>
<td>10.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20</td>
<td>Hiiumaa</td>
<td>22.7</td>
<td>58.8</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>Saaremaa</td>
<td>23.2</td>
<td>58.5</td>
<td>10.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We’ll left join <code>weather_station_to_county_mapping</code> onto the weather tables on latitude/longitude to add a county ID.</p>
<p>Note that there are multiple weather readings for each county ID. Here are a few examples from the <code>forecast_weather</code> table:</p>
<div id="25024d63-36af-46af-a2ff-6e8bc98105a0" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>t_forecast_df <span class="op">=</span> t_forecast_df.merge(weather_station_to_county_mapping_df, on<span class="op">=</span>[<span class="st">'latitude'</span>, <span class="st">'longitude'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>t_forecast_df[<span class="op">~</span>t_forecast_df[<span class="st">'county'</span>].isna()][[<span class="st">'county'</span>, <span class="st">'forecast_datetime'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">forecast_datetime</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>15.0</td>
<td>2023-05-27 03:00:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>15.0</td>
<td>2023-05-27 03:00:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>13.0</td>
<td>2023-05-27 03:00:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24</td>
<td>15.0</td>
<td>2023-05-27 03:00:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>15.0</td>
<td>2023-05-27 03:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>And from the <code>historical_weather</code> table:</p>
<div id="d763e89e-d4f3-41b4-a552-7e5373f7b8dc" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>t_historical_df <span class="op">=</span> t_historical_df.merge(weather_station_to_county_mapping_df, on<span class="op">=</span>[<span class="st">'latitude'</span>, <span class="st">'longitude'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>t_historical_df[<span class="op">~</span>t_historical_df[<span class="st">'county'</span>].isna()][[<span class="st">'county'</span>, <span class="st">'datetime'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">datetime</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>15.0</td>
<td>2023-05-26 11:00:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>15.0</td>
<td>2023-05-26 11:00:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>13.0</td>
<td>2023-05-26 11:00:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24</td>
<td>15.0</td>
<td>2023-05-26 11:00:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>15.0</td>
<td>2023-05-26 11:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We’ll need to do a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.groupby.html">groupby</a> operation to summarize the readings for the same county at the same datetime.</p>
<p>I did the following groupbys on the dates and on the counties:</p>
<ol type="1">
<li><p><strong>date</strong>: mean and standard deviation over <em>all</em> counties (and hence all weather stations in each county) at each unique datetime</p></li>
<li><p><strong>local</strong>: mean and standard deviation over all weather stations in an <em>individual county</em> at each unique datetime, i.e.&nbsp;mean/std of county <em>n</em> at datetime <em>d</em>.</p></li>
</ol>
<p>Now that we know how we’ll merge the tables, let’s look at the training set and clean the data.</p>
</section>
<section id="cleaning-the-data" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="cleaning-the-data"><span class="header-section-number">4</span> Cleaning the data</h2>
<div id="c2b5045c-dcd0-4eba-aeac-aa202193476c" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>segment <span class="op">=</span> [<span class="st">'county'</span>, <span class="st">'is_business'</span>, <span class="st">'product_type'</span>]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data_cols <span class="op">=</span> segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'datetime'</span>, <span class="st">'row_id'</span>, <span class="st">'target'</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>client_cols <span class="op">=</span> segment <span class="op">+</span> [<span class="st">'eic_count'</span>, <span class="st">'installed_capacity'</span>, <span class="st">'date'</span>]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>forecast_cols <span class="op">=</span> [<span class="st">'latitude'</span>, <span class="st">'longitude'</span>, <span class="st">'hours_ahead'</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'temperature'</span>, <span class="st">'dewpoint'</span>, <span class="st">'cloudcover_high'</span>, <span class="st">'cloudcover_low'</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloudcover_mid'</span>, <span class="st">'cloudcover_total'</span>, <span class="st">'10_metre_u_wind_component'</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'10_metre_v_wind_component'</span>, <span class="st">'forecast_datetime'</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'direct_solar_radiation'</span>, <span class="st">'surface_solar_radiation_downwards'</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'snowfall'</span>, <span class="st">'total_precipitation'</span>]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>historical_cols <span class="op">=</span> [<span class="st">'datetime'</span>, <span class="st">'temperature'</span>, <span class="st">'dewpoint'</span>, <span class="st">'rain'</span>, <span class="st">'snowfall'</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'surface_pressure'</span>, <span class="st">'cloudcover_total'</span>, <span class="st">'cloudcover_low'</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloudcover_mid'</span>, <span class="st">'cloudcover_high'</span>, <span class="st">'windspeed_10m'</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'winddirection_10m'</span>, <span class="st">'shortwave_radiation'</span>, <span class="st">'direct_solar_radiation'</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'diffuse_radiation'</span>, <span class="st">'latitude'</span>, <span class="st">'longitude'</span>]</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>electricity_cols <span class="op">=</span> [<span class="st">'forecast_date'</span>, <span class="st">'euros_per_mwh'</span>]</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>gas_cols <span class="op">=</span> [<span class="st">'forecast_date'</span>, <span class="st">'lowest_price_per_mwh'</span>, <span class="st">'highest_price_per_mwh'</span>]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>location_cols <span class="op">=</span> [<span class="st">'longitude'</span>, <span class="st">'latitude'</span>, <span class="st">'county'</span>]</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># prosumer details</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'train.csv'</span>, usecols<span class="op">=</span>data_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>client_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'client.csv'</span>, usecols<span class="op">=</span>client_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co"># weather</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>forecast_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'forecast_weather.csv'</span>, usecols<span class="op">=</span>forecast_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>historical_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'historical_weather.csv'</span>, usecols<span class="op">=</span>historical_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># energy prices</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>electricity_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'electricity_prices.csv'</span>, usecols<span class="op">=</span>electricity_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>gas_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'gas_prices.csv'</span>, usecols<span class="op">=</span>gas_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># location</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>weather_station_to_county_mapping_df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'weather_station_to_county_mapping.csv'</span>, usecols<span class="op">=</span>location_cols, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>county_id_to_name_map_df <span class="op">=</span> pd.read_json(path<span class="op">/</span><span class="st">'county_id_to_name_map.json'</span>, orient<span class="op">=</span><span class="st">'index'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f5641abd-4dbe-4a8a-a925-bb9712d4bbb2" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> [train_df, client_df, forecast_df, historical_df, electricity_df, gas_df]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>df_names <span class="op">=</span> [<span class="st">'train'</span>, <span class="st">'client'</span>, <span class="st">'forecast_weather'</span>, <span class="st">'historical_weather'</span>, <span class="st">'electricity_prices'</span>, <span class="st">'gas_prices'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are the table shapes:</p>
<div id="9049d553-14df-4e2c-8280-c93d64c5bb7a" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>{k:v.shape <span class="cf">for</span> (k,v) <span class="kw">in</span> <span class="bu">zip</span>(df_names, dfs)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>{'train': (2018352, 7),
 'client': (41919, 6),
 'forecast_weather': (3424512, 16),
 'historical_weather': (1710802, 17),
 'electricity_prices': (15286, 2),
 'gas_prices': (637, 3)}</code></pre>
</div>
</div>
<p>We can expect our merged and cleaned result to have about 2 million rows.</p>
<p>Here are the columns and their data types:</p>
<div id="0e8167bd-4721-4269-91db-4150067080e5" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>{k:<span class="bu">dict</span>(v.dtypes) <span class="cf">for</span> (k,v) <span class="kw">in</span> <span class="bu">zip</span>(df_names, dfs)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>{'train': {'county': dtype('int64'),
  'is_business': dtype('int64'),
  'product_type': dtype('int64'),
  'target': dtype('float64'),
  'is_consumption': dtype('int64'),
  'datetime': dtype('O'),
  'row_id': dtype('int64')},
 'client': {'product_type': dtype('int64'),
  'county': dtype('int64'),
  'eic_count': dtype('int64'),
  'installed_capacity': dtype('float64'),
  'is_business': dtype('int64'),
  'date': dtype('O')},
 'forecast_weather': {'latitude': dtype('float64'),
  'longitude': dtype('float64'),
  'hours_ahead': dtype('int64'),
  'temperature': dtype('float64'),
  'dewpoint': dtype('float64'),
  'cloudcover_high': dtype('float64'),
  'cloudcover_low': dtype('float64'),
  'cloudcover_mid': dtype('float64'),
  'cloudcover_total': dtype('float64'),
  '10_metre_u_wind_component': dtype('float64'),
  '10_metre_v_wind_component': dtype('float64'),
  'forecast_datetime': dtype('O'),
  'direct_solar_radiation': dtype('float64'),
  'surface_solar_radiation_downwards': dtype('float64'),
  'snowfall': dtype('float64'),
  'total_precipitation': dtype('float64')},
 'historical_weather': {'datetime': dtype('O'),
  'temperature': dtype('float64'),
  'dewpoint': dtype('float64'),
  'rain': dtype('float64'),
  'snowfall': dtype('float64'),
  'surface_pressure': dtype('float64'),
  'cloudcover_total': dtype('int64'),
  'cloudcover_low': dtype('int64'),
  'cloudcover_mid': dtype('int64'),
  'cloudcover_high': dtype('int64'),
  'windspeed_10m': dtype('float64'),
  'winddirection_10m': dtype('int64'),
  'shortwave_radiation': dtype('float64'),
  'direct_solar_radiation': dtype('float64'),
  'diffuse_radiation': dtype('float64'),
  'latitude': dtype('float64'),
  'longitude': dtype('float64')},
 'electricity_prices': {'forecast_date': dtype('O'),
  'euros_per_mwh': dtype('float64')},
 'gas_prices': {'forecast_date': dtype('O'),
  'lowest_price_per_mwh': dtype('float64'),
  'highest_price_per_mwh': dtype('float64')}}</code></pre>
</div>
</div>
<p>The date columns are currently all stored as Python objects:</p>
<div id="d20421ce-8209-43ce-8978-ef0294a81f85" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>date_cols <span class="op">=</span> [<span class="st">'datetime'</span>, <span class="st">'date'</span>, <span class="st">'forecast_datetime'</span>, <span class="st">'datetime'</span>, <span class="st">'forecast_date'</span>, <span class="st">'forecast_date'</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>[(date_cols[i], df[date_cols[i]].dtype) <span class="cf">for</span> i,df <span class="kw">in</span> <span class="bu">enumerate</span>(dfs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>[('datetime', dtype('O')),
 ('date', dtype('O')),
 ('forecast_datetime', dtype('O')),
 ('datetime', dtype('O')),
 ('forecast_date', dtype('O')),
 ('forecast_date', dtype('O'))]</code></pre>
</div>
</div>
<p>We’ll cast them as a datetime type and check the result:</p>
<div id="5e5dee10-0029-4ec8-9ce1-adcdec6b7fd0" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_datetime(df:pd.DataFrame, date_col:pd.Series):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">    casts date_col in df as datetime type</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    df[date_col] <span class="op">=</span> pd.to_datetime(df[date_col])</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># cast</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>[to_datetime(df, date_cols[i]) <span class="cf">for</span> i,df <span class="kw">in</span> <span class="bu">enumerate</span>(dfs)]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>[(date_cols[i], df[date_cols[i]].dtype) <span class="cf">for</span> i,df <span class="kw">in</span> <span class="bu">enumerate</span>(dfs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>[('datetime', dtype('&lt;M8[ns]')),
 ('date', dtype('&lt;M8[ns]')),
 ('forecast_datetime', dtype('&lt;M8[ns]')),
 ('datetime', dtype('&lt;M8[ns]')),
 ('forecast_date', dtype('&lt;M8[ns]')),
 ('forecast_date', dtype('&lt;M8[ns]'))]</code></pre>
</div>
</div>
<p>Let’s check for missing values:</p>
<div id="789b238d-3cc1-493b-ae67-1c352cd25f00" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_columns_with_missing_values(df):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># columns with missing values</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> <span class="bu">list</span>(df.columns[df.isna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    null_counts <span class="op">=</span> [df[col].isna().<span class="bu">sum</span>() <span class="cf">for</span> col <span class="kw">in</span> cols]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">zip</span>(cols, null_counts))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">dict</span>(<span class="bu">zip</span>(df_names, [get_columns_with_missing_values(df) <span class="cf">for</span> df <span class="kw">in</span> dfs]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>{'train': [('target', 528)],
 'client': [],
 'forecast_weather': [('surface_solar_radiation_downwards', 2)],
 'historical_weather': [],
 'electricity_prices': [],
 'gas_prices': []}</code></pre>
</div>
</div>
<p>There are 528 missing targets, which are few enough to drop. We’ll later fill otherwise missing values with the column modes.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>train</code> contains current targets (the ground truth labels) unlike <code>test</code>. At forecast time, we’ll have 2-day old targets available in <code>revealed_targets</code>. We will construct these 48h lagged targets in later iterations when we do more extensive feature engineering.</p>
</div>
</div>
<p>Next we’ll look for highly skewed columns, particularly those distributed with a long tail to the right. While decision trees can handle these just fine, they can pose problems for models that multiply the input data by a coefficient, like a neural network. This is because the infrequently occurring large numbers can dominate the result.</p>
<div id="cb1fed06-73f2-46f6-bf36-61af6e418033" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_skewed_cols(df:pd.DataFrame):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    df_skew <span class="op">=</span> pd.DataFrame(df.skew(), columns<span class="op">=</span>[<span class="st">'skew'</span>])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    skewed_cols <span class="op">=</span> <span class="bu">list</span>(df_skew[np.<span class="bu">abs</span>(df_skew[<span class="st">'skew'</span>]) <span class="op">&gt;=</span> <span class="fl">0.75</span>].index)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> skewed_cols</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the skewed columns first b/c could include columns you don't want to log-scale, e.g. segment cols, target.</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="bu">dict</span>(<span class="bu">zip</span>(df_names, [get_skewed_cols(df) <span class="cf">for</span> df <span class="kw">in</span> dfs]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>{'train': ['target'],
 'client': ['eic_count', 'installed_capacity'],
 'forecast_weather': ['direct_solar_radiation',
  'surface_solar_radiation_downwards',
  'snowfall',
  'total_precipitation'],
 'historical_weather': ['rain',
  'snowfall',
  'windspeed_10m',
  'shortwave_radiation',
  'direct_solar_radiation',
  'diffuse_radiation'],
 'electricity_prices': ['euros_per_mwh'],
 'gas_prices': ['lowest_price_per_mwh', 'highest_price_per_mwh']}</code></pre>
</div>
</div>
<p>We can visualize some with histograms. Here’s the <code>target</code>:</p>
<div id="f61fbd03-8ffb-4cbe-9a3b-425fa426f85d" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">'target'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="enefit-1_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9769405f-d362-4589-873b-b0e77eb3c821" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>client_df[<span class="st">'installed_capacity'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="enefit-1_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Among the columns we found, we’ll log scale all but the <code>target</code> to squish the large numbers and reduce the skew:</p>
<div id="3079cbf0-2cad-401e-84b4-1eafc2d2cff1" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>skewed_cols <span class="op">=</span> [</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'eic_count'</span>, <span class="st">'installed_capacity'</span>], </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'direct_solar_radiation'</span>, <span class="st">'surface_solar_radiation_downwards'</span>, <span class="st">'snowfall'</span>, <span class="st">'total_precipitation'</span>], </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'rain'</span>, <span class="st">'snowfall'</span>, <span class="st">'windspeed_10m'</span>, <span class="st">'shortwave_radiation'</span>, <span class="st">'direct_solar_radiation'</span>, <span class="st">'diffuse_radiation'</span>], </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'euros_per_mwh'</span>], </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'lowest_price_per_mwh'</span>, <span class="st">'highest_price_per_mwh'</span>]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="70770238-dd47-4be4-b8e6-96d277429314" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_scale_df(df:pd.DataFrame, skewed_cols:<span class="bu">list</span>):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add log scaled columns</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> skewed_cols:</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"log_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.log(df[col]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop the original skewed columns</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>skewed_cols, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># not logging target</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (df, cols) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(dfs[<span class="dv">1</span>:], skewed_cols)):</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    log_scale_df(df, cols)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s the result for <code>installed_capacity</code>:</p>
<div id="e9b87043-722f-4eda-a760-8a686a4de5c2" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>client_df[<span class="st">'log_installed_capacity'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="enefit-1_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we’ll merge the tables:</p>
<div id="b936616e-a92b-4c3b-b62e-ee8e37eecbd2" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_client_features(features_df, client_df): </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to align w/ forecast horizon, shift dates 2 days forward (equivalent to 48h lag)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    client_df[<span class="st">'date'</span>] <span class="op">=</span> client_df[<span class="st">'date'</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create date column in train_df to join on (will drop after)</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(features_df[<span class="st">'datetime'</span>].dt.date)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(client_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>, <span class="st">'is_business'</span>, <span class="st">'product_type'</span>, <span class="st">'date'</span>])</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    features_df.drop(columns<span class="op">=</span>[<span class="st">'date'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _reduce_float64(df):</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    float64_cols <span class="op">=</span> df.select_dtypes(include<span class="op">=</span>[<span class="st">'float64'</span>]).columns.tolist()</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> float64_cols:</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> df[col].astype(<span class="st">'float32'</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_forecast_weather_features(features_df, forecast_df, weather_station_to_county_mapping_df):</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setup</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename forecast_datetime left-join w/ features_df on datetime</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    forecast_df.rename(columns<span class="op">=</span>{<span class="st">'forecast_datetime'</span>: <span class="st">'datetime'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to align w/ forecast horizon, filter by 22-45 hours ahead </span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    forecast_df <span class="op">=</span> forecast_df.loc[(forecast_df[<span class="st">'hours_ahead'</span>] <span class="op">&gt;=</span> <span class="dv">22</span>) <span class="op">&amp;</span> (forecast_df[<span class="st">'hours_ahead'</span>] <span class="op">&lt;=</span> <span class="dv">45</span>)].copy()</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    forecast_df.drop(columns<span class="op">=</span>[<span class="st">'hours_ahead'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add county ID by merging w/ weather_station_to_county_mapping_df</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    forecast_df <span class="op">=</span> forecast_df.merge(</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        weather_station_to_county_mapping_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'longitude'</span>, <span class="st">'latitude'</span>])</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill NaN counties w/ 12: code for 'Unknown' county according to county_id_to_name_map.json</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'county'</span>] <span class="op">=</span> forecast_df[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>) </span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop longitude, latitude</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    forecast_df.drop(columns<span class="op">=</span>[<span class="st">'longitude'</span>, <span class="st">'latitude'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">####### date stats: stats over all counties (and all weather stations in each county) on each unique datetime #######</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># date - mean over all counties on each unique date. drop county b/c left-joining back on 'datetime' only</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    date_mean <span class="op">=</span> forecast_df.groupby([<span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    date_mean.drop(columns<span class="op">=</span>[<span class="st">'county'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># std</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    date_std <span class="op">=</span> forecast_df.groupby([<span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).std()</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    date_std.drop(columns<span class="op">=</span>[<span class="st">'county'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">####### local stats: stats over a county on each unique datetime (mean of county N on date YY-MM-DD) #######</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filter where counties are known each time first and cast county as int to enable left-join</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    local_mean <span class="op">=</span> forecast_df[<span class="op">~</span>forecast_df[<span class="st">'county'</span>].isna()].groupby([<span class="st">'county'</span>, <span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    local_mean[<span class="st">'county'</span>] <span class="op">=</span> local_mean[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>)</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># std</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>    local_std <span class="op">=</span> forecast_df[<span class="op">~</span>forecast_df[<span class="st">'county'</span>].isna()].groupby([<span class="st">'county'</span>, <span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).std()</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    local_std[<span class="st">'county'</span>] <span class="op">=</span> local_std[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>)</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">##</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reduce memory usage of intermediate dfs by casting float64 as float32</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    [_reduce_float64(df) <span class="cf">for</span> df <span class="kw">in</span> [date_mean, date_std, local_mean, local_std]]</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join date stats</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(date_mean, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'datetime'</span>])</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(date_std, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'datetime'</span>], suffixes<span class="op">=</span>(<span class="st">"_mean_fd"</span>, <span class="st">"_std_fd"</span>))</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print("debug - merged all date forecast stats")</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join local stats</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(local_mean, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>, <span class="st">'datetime'</span>])</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(local_std, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>, <span class="st">'datetime'</span>], suffixes<span class="op">=</span>(<span class="st">"_mean_fl"</span>, <span class="st">"_std_fl"</span>))</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print("debug - merged all local forecast stats")</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> date_mean, date_std, local_mean, local_std</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>    gc.collect()</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print("debug - finished adding forecast weather features")</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_historical_weather_features(features_df, historical_df, weather_station_to_county_mapping_df):</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">## setup</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add county ID by merging w/ weather_station_to_county_mapping_df</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>    historical_df <span class="op">=</span> historical_df.merge(</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>        weather_station_to_county_mapping_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'longitude'</span>, <span class="st">'latitude'</span>])</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill NaN counties w/ 12: code for Unknown county according to county_id_to_name_map.json</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>    historical_df[<span class="st">'county'</span>] <span class="op">=</span> historical_df[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>)</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop longitude, latitude </span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    historical_df.drop(columns<span class="op">=</span>[<span class="st">'longitude'</span>, <span class="st">'latitude'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">####### date stats: stats over all counties on each unique date #######</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">## base date stats. drop county b/c joining on 'datetime' only ##</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>    date_mean <span class="op">=</span> historical_df.groupby([<span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    date_mean.drop(columns<span class="op">=</span>[<span class="st">'county'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># std</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>    date_std <span class="op">=</span> historical_df.groupby([<span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).std()</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>    date_std.drop(columns<span class="op">=</span>[<span class="st">'county'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">####### local stats: stats over a county on each unique date (mean of county N on date YY-MM-DD) #######</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">## base local stats. to join on county, datetime: filter where counties are known each time first and cast county as int ## </span></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>    local_mean <span class="op">=</span> historical_df[<span class="op">~</span>historical_df[<span class="st">'county'</span>].isna()].groupby([<span class="st">'county'</span>, <span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>    local_mean[<span class="st">'county'</span>] <span class="op">=</span> local_mean[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>)</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># std</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>    local_std <span class="op">=</span> historical_df[<span class="op">~</span>historical_df[<span class="st">'county'</span>].isna()].groupby([<span class="st">'county'</span>, <span class="st">'datetime'</span>], as_index<span class="op">=</span><span class="va">False</span>).std()</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    local_std[<span class="st">'county'</span>] <span class="op">=</span> local_std[<span class="st">'county'</span>].fillna(<span class="dv">12</span>).astype(<span class="st">'int64'</span>)</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">##</span></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cast float64 as float32 to reduce memory usage</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>    [_reduce_float64(df) <span class="cf">for</span> df <span class="kw">in</span> [date_mean, date_std, local_mean, local_std]]</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join all date stats</span></span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(date_mean, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'datetime'</span>])</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(date_std, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'datetime'</span>], suffixes<span class="op">=</span>(<span class="st">"_mean_hd"</span>, <span class="st">"_std_hd"</span>))</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join all local stats</span></span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(local_mean, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>, <span class="st">'datetime'</span>])</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(local_std, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>, <span class="st">'datetime'</span>], suffixes<span class="op">=</span>(<span class="st">'_mean_hl'</span>, <span class="st">'_std_hl'</span>))</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> date_mean, date_std, local_mean, local_std</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>    gc.collect()</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_electricity_prices_features(features_df, electricity_df):</span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">## setup</span></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename forecast_date left-join w/ features_df on 'datetime'</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>    electricity_df.rename(columns<span class="op">=</span>{<span class="st">'forecast_date'</span>: <span class="st">'datetime'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to align w/ forecast horizon, shift dates forward 1 day (equivalent to 24h lag)</span></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    electricity_df[<span class="st">'datetime'</span>] <span class="op">=</span> electricity_df[<span class="st">'datetime'</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">##</span></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join</span></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(electricity_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'datetime'</span>])</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_gas_prices_features(features_df, gas_df):</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">## setup:</span></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create date column in features_df to join on (will drop after) </span></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(features_df[<span class="st">'datetime'</span>].dt.date)</span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename forecast_date in gas_df to join on</span></span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>    gas_df.rename(columns<span class="op">=</span>{<span class="st">'forecast_date'</span>: <span class="st">'date'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to align w/ forecast horizon, shift dates forward 1 day (equivalent to 24h lag)</span></span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>    gas_df[<span class="st">'date'</span>] <span class="op">=</span> gas_df[<span class="st">'date'</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">##</span></span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># join</span></span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.merge(gas_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'date'</span>])</span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop date</span></span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>    features_df.drop(columns<span class="op">=</span>[<span class="st">'date'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2d78aaa7-6b32-457d-a036-5d6e33434e21" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_client_features(train_df, client_df)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_forecast_weather_features(features_df, forecast_df, weather_station_to_county_mapping_df)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_historical_weather_features(features_df, historical_df, weather_station_to_county_mapping_df)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_electricity_prices_features(features_df, electricity_df)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_gas_prices_features(features_df, gas_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>At this stage, the only feature engineering we’ll do is enriching the representation of dates with metadata like DayofWeek/DayofMonth, is_month_start/end, is_weekend, is_holiday, etc; and capturing periodicity to distinguish hours of the same day or months of the same year.</p>
<div id="43695792-26f0-4328-9c57-697fc3ade430" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_is_holiday_flag(features_df):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># supports years 2021-2026, up to 2 years past competition's approx forecast horizon--approx May 2024</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    estonian_holidays <span class="op">=</span> holidays.country_holidays(<span class="st">'EE'</span>, years<span class="op">=</span>[<span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>, <span class="dv">2024</span>, <span class="dv">2025</span>, <span class="dv">2026</span>])</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'is_holiday'</span>] <span class="op">=</span> [date <span class="kw">in</span> estonian_holidays <span class="cf">for</span> date <span class="kw">in</span> features_df[<span class="st">'datetime'</span>].dt.date]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_is_weekend_flag(features_df):</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">    must call after calling add_datepart</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">    add_datepart encodes Dayofweek as #'s b/w 0-6: </span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">    {0: monday, 1: tuesday ... 5: saturday, 6: sunday}</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    weekends <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">6</span>]</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'is_weekend'</span>] <span class="op">=</span> [day <span class="kw">in</span> weekends <span class="cf">for</span> day <span class="kw">in</span> features_df[<span class="st">'datetimeDayofweek'</span>]]</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_date_features(features_df):</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add Year, Month, Week (of year), Day (of month), Dayof{week, year}, is_{start, end} of {month, quarter, year}</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> add_datepart(features_df, <span class="st">'datetime'</span>, drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add is_weekend flag</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> add_is_weekend_flag(features_df)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add is_holiday flag</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> add_is_holiday_flag(features_df)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># capture orthogonal components (peaks/troughs vs phase shift) of Dayofyear, Hour</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># helps distinguish different months in the same year, hours in the same day</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sin emphasizes vertical diplacement (peaks and troughs)</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cos emphasizes horizontal displacement (phase shift)</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'datetimeHour'</span>] <span class="op">=</span> features_df[<span class="st">'datetime'</span>].dt.hour</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'sin(datetimeDayofyear)'</span>] <span class="op">=</span> np.sin(np.pi <span class="op">*</span> features_df[<span class="st">'datetimeDayofyear'</span>] <span class="op">/</span> <span class="dv">183</span>)</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'sin(datetimeHour)'</span>] <span class="op">=</span> np.sin(np.pi <span class="op">*</span> features_df[<span class="st">'datetimeHour'</span>] <span class="op">/</span> <span class="dv">12</span>) </span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'cos(datetimeDayofyear)'</span>] <span class="op">=</span> np.sin(np.pi <span class="op">*</span> features_df[<span class="st">'datetimeDayofyear'</span>] <span class="op">/</span> <span class="dv">183</span>)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    features_df[<span class="st">'cos(datetimeHour)'</span>] <span class="op">=</span> np.sin(np.pi <span class="op">*</span> features_df[<span class="st">'datetimeHour'</span>] <span class="op">/</span> <span class="dv">12</span>) </span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> features_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7aaf3d6e-42f7-431f-af72-5a533974a0d2" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> add_date_features(features_df)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>features_df.shape, features_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>((2018352, 136),
 Index(['county', 'is_business', 'product_type', 'target', 'is_consumption',
        'datetime', 'row_id', 'log_eic_count', 'log_installed_capacity',
        'temperature_mean_fd',
        ...
        'datetimeIs_year_end', 'datetimeIs_year_start', 'datetimeElapsed',
        'is_weekend', 'is_holiday', 'datetimeHour', 'sin(datetimeDayofyear)',
        'sin(datetimeHour)', 'cos(datetimeDayofyear)', 'cos(datetimeHour)'],
       dtype='object', length=136))</code></pre>
</div>
</div>
<p>The dependent variable is <code>target</code>.</p>
<div id="6c207860-cc9e-4074-a835-faceb7acb57a" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dep_var <span class="op">=</span> <span class="st">'target'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As mentioned earlier, we’ll filter out rows with missing targets and fill otherwise missing values with the column modes.</p>
<div id="a03e7e72-54b4-440e-aba4-66ade01545dd" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>features_df <span class="op">=</span> features_df[features_df[dep_var].notnull()]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>modes <span class="op">=</span> features_df.mode().iloc[<span class="dv">0</span>].copy()</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>features_df.fillna(modes, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s the result:</p>
<div id="3e7f00c3-a7b4-4f2b-861d-8ac9bd10c08f" class="cell" data-execution_count="36">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>get_columns_with_missing_values(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>[]</code></pre>
</div>
</div>
<div id="bccca384-894e-4116-926c-8734794a5356" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>features_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
<th data-quarto-table-cell-role="th">sin(datetimeDayofyear)</th>
<th data-quarto-table-cell-role="th">sin(datetimeHour)</th>
<th data-quarto-table-cell-role="th">cos(datetimeDayofyear)</th>
<th data-quarto-table-cell-role="th">cos(datetimeHour)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.713</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>-0.866025</td>
<td>0.0</td>
<td>-0.866025</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>96.590</td>
<td>1</td>
<td>...</td>
<td>0</td>
<td>-0.866025</td>
<td>0.0</td>
<td>-0.866025</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0.000</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>-0.866025</td>
<td>0.0</td>
<td>-0.866025</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>17.314</td>
<td>1</td>
<td>...</td>
<td>0</td>
<td>-0.866025</td>
<td>0.0</td>
<td>-0.866025</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>2.904</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>-0.866025</td>
<td>0.0</td>
<td>-0.866025</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 136 columns</p>
</div>
</div>
</div>
</div>
<p>Excluding the target, 135 columns is a lot to study at once. As we go on, we’ll narrow our focus to the most influential ones.</p>
<p>Next we’ll split the data to use Sept 2021 - Jan 2023 for training and Feb 23 for validation. From the training set, we’ll drop a random set–and a random amount–of prosumers among those that are common to both training and validation just after splitting, making the validation ones new from the model’s point of view. We’ll indicate how many and which ones we drop with their <code>prediction_unit_id</code>’s (PIDs).</p>
<p>fastai’s <code>TabularPandas</code> class will handle splitting the data as well as encoding continuous and categorical variables.</p>
<div id="1288a840-e122-4621-a394-b47356eb38f6" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> random</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>URLs.LOCAL_PATH <span class="op">=</span> Path(<span class="st">'/notebooks/kaggle/enefit'</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>save_path <span class="op">=</span> URLs.LOCAL_PATH<span class="op">/</span><span class="st">'predict-energy-behavior-of-prosumers/pkl_files'</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>pid_lookup_df <span class="op">=</span> load_pickle(save_path<span class="op">/</span><span class="st">'pid_lookup.pkl'</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># includes dates of revealed_targets (2 days behind first eval day feb 1, 2023)</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>train_dates <span class="op">=</span> {</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'part'</span>: [pd.to_datetime(<span class="st">'2022-11-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-01-29 23:00:00'</span>)],</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'full'</span>: [pd.to_datetime(<span class="st">'2021-09-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-01-29 23:00:00'</span>)]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>eval_dates <span class="op">=</span> {<span class="st">'feb23'</span>: [pd.to_datetime(<span class="st">'2023-02-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-02-28 23:00:00'</span>)],</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">'mar23'</span>: [pd.to_datetime(<span class="st">'2023-03-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-03-31 23:00:00'</span>)],</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">'apr23'</span>: [pd.to_datetime(<span class="st">'2023-04-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-04-30 23:00:00'</span>)],</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">'may23'</span>: [pd.to_datetime(<span class="st">'2023-05-01 00:00:00'</span>), pd.to_datetime(<span class="st">'2023-05-31 23:00:00'</span>)]</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>             }</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_endpoints(is_partial, features_df, eval_month:<span class="bu">str</span>):</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_partial:</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        train_dates_conds <span class="op">=</span> [features_df[<span class="st">'datetime'</span>] <span class="op">==</span> train_dates[<span class="st">'part'</span>][<span class="dv">0</span>], </span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>                             features_df[<span class="st">'datetime'</span>] <span class="op">==</span> train_dates[<span class="st">'part'</span>][<span class="dv">1</span>]</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>                            ]</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        train_dates_conds <span class="op">=</span> [features_df[<span class="st">'datetime'</span>] <span class="op">==</span> train_dates[<span class="st">'full'</span>][<span class="dv">0</span>], </span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>                             features_df[<span class="st">'datetime'</span>] <span class="op">==</span> train_dates[<span class="st">'full'</span>][<span class="dv">1</span>]</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>                            ]</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    train_endpoints <span class="op">=</span> [features_df[<span class="st">'datetime'</span>][train_dates_conds[<span class="dv">0</span>]].index[<span class="dv">0</span>], </span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>                       features_df[<span class="st">'datetime'</span>][train_dates_conds[<span class="dv">1</span>]].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>                      ]</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    valid_dates_cond <span class="op">=</span> [features_df[<span class="st">'datetime'</span>] <span class="op">==</span> eval_dates[eval_month][<span class="dv">0</span>], </span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>                        features_df[<span class="st">'datetime'</span>] <span class="op">==</span> eval_dates[eval_month][<span class="dv">1</span>]</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>                       ]</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    valid_endpoints <span class="op">=</span> [features_df[<span class="st">'datetime'</span>][valid_dates_cond[<span class="dv">0</span>]].index[<span class="dv">0</span>], </span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>                       features_df[<span class="st">'datetime'</span>][valid_dates_cond[<span class="dv">1</span>]].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>                      ]</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_endpoints, valid_endpoints</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_splits(is_partial, features_df, eval_month:<span class="bu">str</span>):</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>    train_endpoints, valid_endpoints <span class="op">=</span> get_endpoints(is_partial, features_df, eval_month)</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> features_df.iloc[train_endpoints[<span class="dv">0</span>]:train_endpoints[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>].index.tolist()</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> features_df.iloc[valid_endpoints[<span class="dv">0</span>]:valid_endpoints[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>].index.tolist()</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>    splits <span class="op">=</span> (train, valid)</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> splits</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> drop_pids_from_train(features_df, splits, pid_lookup_df):</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>    max_n_pids_to_drop <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>    training_pids <span class="op">=</span> <span class="bu">set</span>(features_df.iloc[splits[<span class="dv">0</span>]].merge(pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>])[<span class="st">'prediction_unit_id'</span>].unique().tolist())</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>    valid_pids <span class="op">=</span> <span class="bu">set</span>(features_df.iloc[splits[<span class="dv">1</span>]].merge(pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>])[<span class="st">'prediction_unit_id'</span>].unique().tolist())</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>    intersection_pids <span class="op">=</span> <span class="bu">list</span>(training_pids.intersection(valid_pids))</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pids drop list may not be continuous or sorted.</span></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>    intersection_pids.sort() </span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop from those not already missing in the valid fold, THIS ROUND.</span></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to get the number of pids to drop THIS ROUND, pick a random int b/w 1 and the max allowed to drop.</span></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>    n_pids_drop <span class="op">=</span> random.randint(<span class="dv">1</span>, max_n_pids_to_drop) </span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to get the pids to drop, index intersection_pids w/ a random int b/w 0 and its last index. repeat for the n_pids_drop chosen for THIS ROUND. </span></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>    pids_to_drop <span class="op">=</span> [random.randint(<span class="dv">0</span>, <span class="bu">len</span>(intersection_pids)<span class="op">-</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_pids_drop)]</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop only from train (slice features_df by training dates from the endpoints, join to lookup pids, mask, apply the mask to the slice)</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get its indices</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> features_df.iloc[splits[<span class="dv">0</span>]].merge(pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>])[<span class="st">'prediction_unit_id'</span>].isin(pids_to_drop)</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mask, n_pids_drop, pids_to_drop</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_tabular_pandas(features_df, procs, max_card, splits, dep_var<span class="op">=</span><span class="st">'target'</span>):  </span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variables</span></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>    cont, cat <span class="op">=</span> cont_cat_split(features_df, max_card, dep_var<span class="op">=</span>dep_var)</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setup object</span></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TabularPandas(features_df, procs, cat, cont, y_names<span class="op">=</span>dep_var, splits<span class="op">=</span>splits)</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_training(is_partial, features_df, pid_lookup_df, eval_month, procs, max_card):</span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>    features_df <span class="op">=</span> features_df.reset_index(drop<span class="op">=</span><span class="va">True</span>)      </span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>    tmp_splits <span class="op">=</span> get_splits(is_partial, features_df, eval_month)</span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># _get_splits -&gt; _get_pids_drop_mask needs row_id to join pid_lookup_df</span></span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>    pid_mask, n_pids_dropped, pids_dropped <span class="op">=</span> drop_pids_from_train(features_df, tmp_splits, pid_lookup_df)</span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    valid_buffer <span class="op">=</span> pd.Series(np.zeros(<span class="bu">len</span>(tmp_splits[<span class="dv">1</span>]), dtype<span class="op">=</span><span class="st">'bool'</span>))</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>    pid_mask <span class="op">=</span> pd.concat([pid_mask, valid_buffer])</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>    pid_mask.index <span class="op">=</span> tmp_splits[<span class="dv">0</span>] <span class="op">+</span> tmp_splits[<span class="dv">1</span>]</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>    tmp_df <span class="op">=</span> features_df.iloc[tmp_splits[<span class="dv">0</span>]<span class="op">+</span>tmp_splits[<span class="dv">1</span>]][<span class="op">~</span>pid_mask]</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>    features_df_final <span class="op">=</span> tmp_df.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># re-compute the splits after applying pid_mask.</span></span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>    final_splits <span class="op">=</span> get_splits(is_partial, features_df_final, eval_month)</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> tmp_splits, tmp_df</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>    gc.collect()</span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setup training</span></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>    procs <span class="op">=</span> procs</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>    max_card <span class="op">=</span> max_card</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>    to <span class="op">=</span> setup_tabular_pandas(features_df_final, procs, max_card, final_splits)</span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"n_pids_dropped from train: </span><span class="sc">{</span>n_pids_dropped<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"pids_dropped from train: </span><span class="sc">{</span>pids_dropped<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> to, final_splits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="28367cbb-1de5-474d-9e9f-98d790430773" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>is_partial <span class="op">=</span> <span class="va">False</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>eval_month <span class="op">=</span> <span class="st">'feb23'</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>max_card <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>to, final_splits <span class="op">=</span> setup_training(is_partial, features_df, pid_lookup_df, eval_month, procs, max_card)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>n_pids_dropped from train: 4
pids_dropped from train: [14, 60, 20, 23]</code></pre>
</div>
</div>
</section>
<section id="modeling-with-trees" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="modeling-with-trees"><span class="header-section-number">5</span> Modeling with trees</h2>
<p>With our pre-processing done, there are no missing values and the data is all numeric. We’re ready to train a model! Since decision trees are easy to train and interpret, we’ll start there.</p>
<p>Let’s define our independent and dependent variables:</p>
<div id="81189135-6a2d-43e5-bf40-c0a91723db0a" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_and_valid(to):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    xs, y <span class="op">=</span> to.train.xs, to.train.y</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    valid_xs, valid_y <span class="op">=</span> to.valid.xs, to.valid.y</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xs, y, valid_xs, valid_y</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>xs, y, valid_xs, valid_y <span class="op">=</span> get_train_and_valid(to)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(xs), <span class="bu">len</span>(y), <span class="bu">len</span>(valid_xs), <span class="bu">len</span>(valid_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1531020 1531020 89808 89808</code></pre>
</div>
</div>
<p>And train a small tree with <code>sklearn</code>, limiting to 4 leaf nodes for simplicity:</p>
<div id="8306a0c4-6363-4c37-b05f-29ca270e22c1" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> DecisionTreeRegressor(max_leaf_nodes<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>m.fit(xs, y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 28.1 s, sys: 937 ms, total: 29 s
Wall time: 29 s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="41">
<style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DecisionTreeRegressor(max_leaf_nodes=4)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">DecisionTreeRegressor</label><div class="sk-toggleable__content"><pre>DecisionTreeRegressor(max_leaf_nodes=4)</pre></div></div></div></div></div>
</div>
</div>
<p><code>fastai</code>’s <code>draw_tree</code> function displays what the tree learned:</p>
<div id="cell-fig-draw-tree" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>draw_tree(m, xs, size<span class="op">=</span><span class="dv">15</span>, leaves_parallel<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<div id="fig-draw-tree" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-draw-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-draw-tree-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-draw-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Visualizing the decision criteria
</figcaption>
</figure>
</div>
</div>
</div>
<p>The top node is the initial model before any splits have been made. The model has the data all in one group (samples = 1531020—the total size of the training set), and always predicts the target to be its average value over the whole dataset (254.05). The mean squared error between this value and the actual targets is 805354.01. The tree-building algorithm found the best split to be on <code>log_installed_capacity</code>, with the decision criteria (a Yes or No question) being whether <code>log_installed_capacity</code> is less than or equal to 9.41.</p>
<p>The node moving down to the left shows that there are 1503570 rows where <code>log_installed_capacity</code> is less than or equal to 9.41. In this group, the average value of the target is 186.89. The best next split was found to be whether <code>log_installed_capacity</code> is less than or equal to 8.59.</p>
<p>If we instead moved down to the right, we have rows where <code>log_installed_capacity</code> is greater than 9.41. The best next split from here is on <code>is_consumption</code>.</p>
<p>The nodes on the bottom row are the leaf nodes; no further questions are asked. We can see that with each split, the model successfully separates larger targets from smaller targets, and that the resulting groups’ average values differ significantly.</p>
<p>With Terrence Parr’s <a href="https://explained.ai/decision-tree-viz/">dtreeviz</a> library, we can gain further insight from the same model:</p>
<div id="cell-fig-dtreeviz" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample 1% points</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dtreeviz</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>samp_idx <span class="op">=</span> np.random.permutation(<span class="bu">len</span>(y))</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>samp_idx.sort()</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>samp_idx <span class="op">=</span> samp_idx[:<span class="dv">20000</span>]</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>treeviz <span class="op">=</span> dtreeviz.model(m, xs.iloc[samp_idx], y.iloc[samp_idx], feature_names<span class="op">=</span>xs.columns, target_name<span class="op">=</span>dep_var)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>treeviz.view(fontname<span class="op">=</span><span class="st">'DejaVu Sans'</span>, scale<span class="op">=</span><span class="fl">1.6</span>, label_fontsize<span class="op">=</span><span class="dv">10</span>, orientation<span class="op">=</span><span class="st">'LR'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="43">
<div id="fig-dtreeviz" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dtreeviz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-dtreeviz-output-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dtreeviz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Visualizing the target distribution after each split
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>TabularPandas</code> encodes categorical variables by replacing each unique level with a number. The numbers for each level are chosen consecutively based on the level’s order of appearance, but they have no particular meaning.</p>
</div>
</div>
<p><a href="#fig-dtreeviz" class="quarto-xref">Figure&nbsp;2</a> shows the target distribution at each split point. The targets splitting on <code>is_consumption</code> have quite different distributions, which is in turn reflected in the leaf nodes: the average production (1) is 492.46, and the average consumption (2) is 7373.03. Perhaps it’s worth investigating the groups more closely in a later iteration, even modeling them separately.</p>
<p>In <code>is_consumption</code>, 0 (production) appears first and 1 (consumption) appears second, as seen before the <code>TabularPandas</code> was created:</p>
<div id="8bb7b539-7068-428c-bd58-b66b37fa23d6" class="cell" data-execution_count="84">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>features_df[segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'datetimeYear'</span>, <span class="st">'datetimeMonth'</span>, <span class="st">'datetimeDay'</span>, <span class="st">'datetimeHour'</span>]].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="84">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">datetimeYear</th>
<th data-quarto-table-cell-role="th">datetimeMonth</th>
<th data-quarto-table-cell-role="th">datetimeDay</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>2021</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>2021</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>2021</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We can see TabularPandas encoded production and consumption as 1 and 2 respectively:</p>
<div id="b4293ee4-551d-4cdd-983c-f9e3f5a1b6ea" class="cell" data-execution_count="85">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>xs[:<span class="dv">3</span>][segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'datetimeYear'</span>, <span class="st">'datetimeMonth'</span>, <span class="st">'datetimeDay'</span>, <span class="st">'datetimeHour'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="85">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">datetimeYear</th>
<th data-quarto-table-cell-role="th">datetimeMonth</th>
<th data-quarto-table-cell-role="th">datetimeDay</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>1</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>1</td>
<td>3</td>
<td>1</td>
<td>1</td>
<td>9</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We need to evaluate the models as we go on. The competition is scored on mean absolute error (MAE), so we’ll create functions to calculate it:</p>
<div id="b309a692-5ebd-4a2d-8257-236d23cc4b43" class="cell" data-execution_count="46">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mae(preds, y): <span class="cf">return</span> <span class="bu">round</span>((preds<span class="op">-</span>y).<span class="bu">abs</span>().mean(), <span class="dv">6</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> m_mae(m, xs, y): <span class="cf">return</span> mae(m.predict(xs), y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s train a larger tree:</p>
<div id="1c1bb953-1ecc-490a-861f-cd69cd2c636e" class="cell" data-execution_count="47">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> DecisionTreeRegressor(min_samples_leaf<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>m.fit(to.train.xs, to.train.y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 4min 16s, sys: 1.41 s, total: 4min 17s
Wall time: 4min 18s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="47">
<style>#sk-container-id-2 {color: black;background-color: white;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DecisionTreeRegressor(min_samples_leaf=25)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked=""><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">DecisionTreeRegressor</label><div class="sk-toggleable__content"><pre>DecisionTreeRegressor(min_samples_leaf=25)</pre></div></div></div></div></div>
</div>
</div>
<div id="713b5999-f4f1-4bd3-9de9-ba3c0c2017d0" class="cell" data-execution_count="48">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs, y))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs, valid_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  22.86435
valid mae:  82.516897</code></pre>
</div>
</div>
<div id="18cc3740-917c-42ec-b3b5-cc70303bd3b1" class="cell" data-execution_count="49">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>m.get_n_leaves(), <span class="bu">len</span>(xs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>(41727, 1531020)</code></pre>
</div>
</div>
<p>As shown, the training error is quite a bit less than the validation error, so this model is overfitting. However, with ~42000 leaves vs ~1.5 million rows, it’s apparently not because the leaf nodes are near as many as the number of rows. If that was the case, the tree has essentially become a perfect charades guesser: it simply describes the rows rather than having learned underlying patterns about them.</p>
<p>There’s a tradeoff between how accurate the tree is on the training set and how well it generalizes. Smaller trees generalize better, but larger trees are more accurate. A random forest brings the best of both worlds while also being easy to train and interpret. Let’s train one next.</p>
<div id="129778d8-ad35-434a-95f9-7c4dbd93e038" class="cell" data-execution_count="50">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rf(xs, y, n_estimators<span class="op">=</span><span class="dv">40</span>, max_features<span class="op">=</span><span class="fl">0.5</span>, min_samples_leaf<span class="op">=</span><span class="dv">5</span>, <span class="op">**</span>kwargs):</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RandomForestRegressor(n_jobs<span class="op">=-</span><span class="dv">1</span>, </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                                 n_estimators<span class="op">=</span>n_estimators,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                                 max_samples<span class="op">=</span><span class="bu">int</span>(<span class="fl">0.5</span><span class="op">*</span><span class="bu">len</span>(xs)), </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>                                 max_features<span class="op">=</span>max_features,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>                                 min_samples_leaf<span class="op">=</span>min_samples_leaf, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                                 oob_score<span class="op">=</span><span class="va">True</span>).fit(xs, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8beaddd6-6eea-410e-a243-a0fa6ca3c711" class="cell" data-execution_count="51">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 53min 22s, sys: 4.25 s, total: 53min 27s
Wall time: 9min 24s</code></pre>
</div>
</div>
<div id="5b9532bf-887c-4858-a031-4b9dc3e7e8d0" class="cell" data-execution_count="52">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs, y))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs, valid_y))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB error: "</span>, mae(m.oob_prediction_, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  16.108207
valid mae:  57.444592
OOB error:  21.931264</code></pre>
</div>
</div>
<p>Our random forest is also overfitting, but the validation error improved a fair bit compared to the decision tree’s 82.5.</p>
<p>A random forest is a ensemble of decision trees constructed by bagging: several decision trees are trained on a random subset of rows and columns. We trained 40 trees each on random choices of half the rows and half the columns. The randomness is meant to make the trees independent from one another so that their errors are also independent. Some trees overstimate the target while others underestimate it. Berkeley professor Leo Breiman, the inventor of bagging, had the insight that such independent predictors’ average error will tend to 0.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Bagging reflects the “<a href="https://en.wikipedia.org/wiki/Wisdom_of_the_crowd">wisdom of crowds</a>”, the idea that large groups of people are collectively smarter than individual experts. But it assumes that the individuals think for themselves and aren’t easily influenced by others. If the trees in the random forest were all built on the same subset of rows and columns, they’d all make the same decisions (as well as mistakes) in the same ways, reflecting instead the “<a href="https://en.wikipedia.org/wiki/Extraordinary_Popular_Delusions_and_the_Madness_of_Crowds">madness of crowds</a>”. Bagging helps ensure the crowd is wise rather than just insane.</p>
</div>
</div>
<p>The out-of-bag (OOB) error is the average error across all trees on rows that each individual tree wasn’t trained on, as if these rows were the tree’s own validation set. Since the OOB error is significantly lower than the ensemble’s validation error, the individual trees are not overfitting their training subsets badly enough to drive the ensemble’s error. Something is affecting the ensemble’s performance, in addition to normal overfitting. One factor is likely the domain shift inherent in time series forecasting: training data is older than validation data and may exhibit patterns that aren’t valid anymore.</p>
<p>Some prosumers may be especially tricky to model. To discover hard examples, we can assess a prediction’s relative confidence: its standard deviation across all trees. Let’s look at relative confidence for the first 5 validation examples:</p>
<div id="efa17b70-5dd9-467d-878d-1e0da5fbf288" class="cell" data-execution_count="53">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the predictions of each tree (40 trees, 89808 preds per tree)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 40 tensors, each a rank 1 tensor (vector) of 7988 preds (7988 rows)</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> np.stack([t.predict(valid_xs) <span class="cf">for</span> t <span class="kw">in</span> m.estimators_])</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get std of preds over all trees</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>preds_std <span class="op">=</span> preds.std(<span class="dv">0</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co"># std for first 5 targets</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>preds_std[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>array([ 56.83899946, 189.77693871,   1.63845795,   6.62099179,   4.81058034])</code></pre>
</div>
</div>
<p>The confidence varies widely. Let’s take a closer look:</p>
<div id="a08054bc-6739-4f10-bfaa-9e41190d2018" class="cell" data-execution_count="54">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>valid_xs.merge(pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>])[segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'prediction_unit_id'</span>]][:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="54">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">prediction_unit_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>1</td>
<td>3</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>PID 0 seems to have much higher standard deviations (lower relative confidence) than PIDs 1 and 2. It’s predictions for consumption (2) are much less confident than for production (1) as well. We can get a broader sense of relative confidence from its quartiles:</p>
<div id="69549620-4b77-4b8d-bce9-fd14688d4340" class="cell" data-execution_count="55">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(preds_std).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>89808.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>102.017488</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>224.477415</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>0.001592</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>4.270308</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>16.668092</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>97.181082</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>2899.394995</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We can see that the predictions’ standard deviations range from 0 (most confident) to ~2900 (least confident), with the middle 50% between ~4 and ~97.</p>
<p>To zero in on the hardest examples, we’ll break down the sample distribution in the top quartile:</p>
<div id="7c5d3284-69f3-450d-9cc0-a11971684427" class="cell" data-execution_count="56">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>[<span class="bu">len</span>(np.where(preds_std <span class="op">&gt;=</span> threshold)[<span class="dv">0</span>]) <span class="cf">for</span> threshold <span class="kw">in</span> [<span class="dv">97</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">2500</span>, <span class="dv">2600</span>, <span class="dv">2700</span>, <span class="dv">2800</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>[22475, 1479, 416, 75, 33, 19, 7, 1]</code></pre>
</div>
</div>
<p>The hardest 7 examples have a standard deviation of at least 2700. With the provided <code>county_id_to_name_map</code>, we can view them alongside the <code>county_names</code>.</p>
<div id="e6b49ad2-5d09-411a-9330-6db5140dcb0c" class="cell" data-execution_count="57">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>county_id_to_name_map_df.insert(loc<span class="op">=</span><span class="dv">0</span>, column<span class="op">=</span><span class="st">'county'</span>, value<span class="op">=</span>county_id_to_name_map_df.index)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>county_id_to_name_map_df[<span class="st">'county'</span>] <span class="op">=</span> county_id_to_name_map_df[<span class="st">'county'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>county_id_to_name_map_df.columns <span class="op">=</span> [<span class="st">'county'</span>, <span class="st">'county_name'</span>]</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>county_id_to_name_map_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="57">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">county_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>HARJUMAA</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>HIIUMAA</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>IDA-VIRUMAA</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>JÄRVAMAA</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>JÕGEVAMAA</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="8b0be602-5cfd-4809-bd4e-1c4676696e9a" class="cell">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>date_meta_cols <span class="op">=</span> [<span class="st">'datetimeYear'</span>, <span class="st">'datetimeMonth'</span>, <span class="st">'datetimeHour'</span>, <span class="st">'is_weekend'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s the hardest example:</p>
<div id="7c3f4345-c089-443c-97fb-0bf9cd8e8bf9" class="cell" data-execution_count="61">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> np.where(preds_std <span class="op">&gt;=</span> <span class="dv">2800</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>valid_xs.iloc[cond</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>].merge(</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>]</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>).merge(</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    county_id_to_name_map_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>]</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'prediction_unit_id'</span>, <span class="st">'county_name'</span>] <span class="op">+</span> date_meta_cols</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="61">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">prediction_unit_id</th>
<th data-quarto-table-cell-role="th">county_name</th>
<th data-quarto-table-cell-role="th">datetimeYear</th>
<th data-quarto-table-cell-role="th">datetimeMonth</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
<th data-quarto-table-cell-role="th">is_weekend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>14</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p><code>TabularPandas</code> encoded the date columns above as follows:</p>
<ul>
<li><code>datetimeYear</code>: years 2021, 2022 and 2023 as 1, 2, and 3, respectively</li>
<li><code>datetime_Month</code>: months Jan-Dec as 1-12, respectively</li>
<li><code>datetime_hour</code>: the start of each hour in a day (12am-11pm) as 0-23, respectively</li>
<li><code>is_weekend</code>: False as 1 and True as 2</li>
</ul>
<p>So it’s a consumption target in Harjumaa, at 2pm on a weekday in Feb 2023.</p>
<p>Here are the 7 hardest examples:</p>
<div id="f62cbc03-525f-47d5-b54c-6489bc40c8fb" class="cell" data-execution_count="87">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> (preds_std <span class="op">&gt;=</span> <span class="dv">2700</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>valid_xs.iloc[cond</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>].merge(</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>]</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>).merge(</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    county_id_to_name_map_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>]</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'prediction_unit_id'</span>, <span class="st">'county_name'</span>] <span class="op">+</span> date_meta_cols</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="87">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">prediction_unit_id</th>
<th data-quarto-table-cell-role="th">county_name</th>
<th data-quarto-table-cell-role="th">datetimeYear</th>
<th data-quarto-table-cell-role="th">datetimeMonth</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
<th data-quarto-table-cell-role="th">is_weekend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>7</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>13</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>15</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>12</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>13</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>14</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>2</td>
<td>5</td>
<td>HARJUMAA</td>
<td>3</td>
<td>2</td>
<td>17</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Interesting. They’re all consumption targets in Harjumaa, mostly between 1-5pm on weekdays in Feb 2023.</p>
<div id="be8c60f4-5950-46dc-8161-145fc068abf3" class="cell" data-execution_count="90">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> (preds_std <span class="op">&gt;=</span> <span class="dv">1000</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>valid_xs.iloc[cond</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>].merge(</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    pid_lookup_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'row_id'</span>]</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>).merge(</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    county_id_to_name_map_df, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'county'</span>]</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    segment <span class="op">+</span> [<span class="st">'is_consumption'</span>, <span class="st">'prediction_unit_id'</span>, <span class="st">'county_name'</span>]</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>][<span class="st">'county_name'</span>].unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>array(['HARJUMAA', 'VÕRUMAA', 'TARTUMAA'], dtype=object)</code></pre>
</div>
</div>
<p>The hardest examples (top ~1.7%) are in Harjumaa, Võrumaa, and Tartumaa.</p>
<p>Next, let’s look at what features were found to be the strongest predictors with feature importances:</p>
<div id="78a6a118-386d-4ca4-bef5-35062e3d6173" class="cell" data-execution_count="91">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rf_feat_importance(m, df):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({<span class="st">'cols'</span>:df.columns, <span class="st">'imp'</span>:m.feature_importances_}</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>                       ).sort_values(<span class="st">'imp'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fi(fi):</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fi.plot(<span class="st">'cols'</span>, <span class="st">'imp'</span>, <span class="st">'barh'</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">7</span>), legend<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="a3bfd163-5ef2-4521-bb63-66914062a43a" class="cell" data-execution_count="92">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>fi <span class="op">=</span> rf_feat_importance(m, xs)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>fi[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="92">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cols</th>
<th data-quarto-table-cell-role="th">imp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>log_installed_capacity</td>
<td>0.334581</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>is_consumption</td>
<td>0.323513</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17</td>
<td>log_eic_count</td>
<td>0.089307</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>is_business</td>
<td>0.088815</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>product_type</td>
<td>0.016892</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>county</td>
<td>0.015490</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>log_surface_solar_radiation_downwards_mean_fd</td>
<td>0.015466</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">130</td>
<td>datetimeHour</td>
<td>0.011871</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">78</td>
<td>log_shortwave_radiation_mean_hd</td>
<td>0.011550</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>is_weekend</td>
<td>0.009973</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We’ll plot the scores to compare more clearly:</p>
<div id="cell-fig-feat-imp" class="cell" data-execution_count="93">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>plot_fi(fi[:<span class="dv">35</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-feat-imp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-feat-imp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-feat-imp-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-feat-imp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Plotting random forest feature importances
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The feature importance algorithm calculates the scores by looping through each tree and recursing on each branch. At each branch, it looks at what feature was used for the split and how much the model improved as a result. The improvement is weighted by samples in that group and added to the importance score of that feature. These are summed across all branches of all trees. Finally, the scores for all features are normalized so they add to 1.</p>
</div>
</div>
<p><code>log_installed_capacity</code> and <code>is_consumption</code> are the top two predictors, matching our earlier findings. Features relating to the segment, solar radiation, the time of day, and whether it’s a weekend seem intuitive as well.</p>
<p>It seems like we can simplify our model by ignoring unimportant features. We’ll try keeping the top-scoring 25%, which works out to a score of 0.001 or more.</p>
<div id="eb3b2314-3be7-495c-8191-ef23a2e6e594" class="cell" data-execution_count="94">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># keep approx top 25-33%</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>to_keep <span class="op">=</span> fi[fi.imp<span class="op">&gt;</span><span class="fl">0.001</span>].cols</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(xs.columns), <span class="bu">len</span>(to_keep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(135, 31)</code></pre>
</div>
</div>
<div id="ae206922-6472-4cee-9695-9f165f5831cd" class="cell" data-execution_count="95">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>xs_imp <span class="op">=</span> xs[to_keep]</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>valid_xs_imp <span class="op">=</span> valid_xs[to_keep]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And train again:</p>
<div id="9ce89398-9aad-4392-92bf-e6da79fff6da" class="cell" data-execution_count="96">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs_imp, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 11min 18s, sys: 3.05 s, total: 11min 21s
Wall time: 2min 10s</code></pre>
</div>
</div>
<div id="513afba2-d8ab-4f41-9329-1eac4eee734f" class="cell" data-execution_count="97">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs_imp, y))</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs_imp, valid_y))</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB error: "</span>, mae(m.oob_prediction_, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  17.5442
valid mae:  57.84291
OOB error:  22.304685</code></pre>
</div>
</div>
<p>Recall our earlier model, which used all 135 features:</p>
<ul>
<li>train mae: 16.108207</li>
<li>valid mae: 57.444592</li>
<li>OOB error: 21.931264</li>
</ul>
<p>We’ve near matched that performance using just 31 features (less than a quarter of the total)! This is much more managable to study in depth.</p>
<p>Let’s try to go further by removing potentially redundant features:</p>
<div id="cell-fig-cluster-cols" class="cell" data-execution_count="98">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>cluster_columns(xs_imp, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">11</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-cluster-cols" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cluster-cols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-cluster-cols-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cluster-cols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Visualizing feature similarity
</figcaption>
</figure>
</div>
</div>
</div>
<p><code>fastai</code>’s <code>cluster_columns</code> function calculates the similarity (rank correlation) between features. In <a href="#fig-cluster-cols" class="quarto-xref">Figure&nbsp;4</a>, the most similar features are merged early, far from the tree’s root on the left.</p>
<p>The following appear closely related since they merged earliest:</p>
<ul>
<li><code>datetime</code>, <code>datetimeElapsed</code>, and <code>row_id</code></li>
<li><code>temperature_mean_fd</code> and <code>temperature_mean_hd</code></li>
<li><code>cos(datetimeDayofyear)</code> and <code>sin(datetimeDayofyear)</code></li>
</ul>
<p>Let’s see what we else can remove without losing accuracy. We’ll quickly train a small random forest and use its OOB score attribute to measure accuracy. OOB score is R-squared, with 1.0 for a perfect model and 0.0 for a random model.</p>
<div id="20427c67-ff7b-49f1-b156-53ecc40497f6" class="cell" data-execution_count="99">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"max_samples: "</span>, <span class="bu">int</span>(<span class="fl">0.05</span><span class="op">*</span><span class="bu">len</span>(xs_imp)))</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_oob(df):</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">40</span>, min_samples_leaf<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>        max_samples<span class="op">=</span><span class="bu">int</span>(<span class="fl">0.05</span><span class="op">*</span><span class="bu">len</span>(xs_imp)), max_features<span class="op">=</span><span class="fl">0.5</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>, oob_score<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    m.fit(df, y)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m.oob_score_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>max_samples:  76551</code></pre>
</div>
</div>
<p>We’ll get a baseline score:</p>
<div id="e86d3375-f783-4b07-9d2e-7c45c1269e91" class="cell" data-execution_count="100">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># baseline</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>get_oob(xs_imp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>0.9750720346249664</code></pre>
</div>
</div>
<p>And drop the potentially redundant features one at a time first:</p>
<div id="197edd29-1379-453f-a108-dd898cbf0782" class="cell" data-execution_count="101">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>{c:get_oob(xs_imp.drop(c, axis<span class="op">=</span><span class="dv">1</span>)) <span class="cf">for</span> c <span class="kw">in</span> (<span class="st">'sin(datetimeDayofyear)'</span>, <span class="st">'cos(datetimeDayofyear)'</span>, <span class="st">'temperature_mean_fd'</span>, <span class="st">'temperature_mean_hd'</span>, </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">'datetime'</span>, <span class="st">'datetimeElapsed'</span>, <span class="st">'row_id'</span>,)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 9min 24s, sys: 17.6 s, total: 9min 42s
Wall time: 3min 6s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>{'sin(datetimeDayofyear)': 0.9748840187574119,
 'cos(datetimeDayofyear)': 0.9747854942031892,
 'temperature_mean_fd': 0.9756331334112932,
 'temperature_mean_hd': 0.9739451030232441,
 'datetime': 0.9740079246614726,
 'datetimeElapsed': 0.9750031089303453,
 'row_id': 0.9749748373792562}</code></pre>
</div>
</div>
<p>Now let’s try removing multiple at once, one from each closely related pair.</p>
<div id="6566a312-019b-48b9-b096-601d4de8fdc1" class="cell" data-execution_count="114">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>to_drop <span class="op">=</span> [<span class="st">'cos(datetimeDayofyear)'</span>, <span class="st">'temperature_mean_fd'</span>, <span class="st">'datetime'</span>, <span class="st">'row_id'</span>]</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>get_oob(xs_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>0.9750910616501632</code></pre>
</div>
</div>
<p>Looks like we can remove them with minimal impact. Let’s do so and train another model:</p>
<div id="b74a0204-6cf8-4b99-867d-26569366c6cf" class="cell" data-execution_count="115">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>xs_final <span class="op">=</span> xs_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>valid_xs_final <span class="op">=</span> valid_xs_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2dc3e888-2baf-49ec-9289-48954ab9e387" class="cell" data-execution_count="116">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs_final, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 9min 15s, sys: 2.51 s, total: 9min 17s
Wall time: 1min 48s</code></pre>
</div>
</div>
<div id="effe773a-a151-4b52-91ae-66b46fa155fc" class="cell" data-execution_count="117">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs_final, y))</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs_final, valid_y))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB error: "</span>, mae(m.oob_prediction_, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  17.829288
valid mae:  49.70654
OOB error:  22.560125</code></pre>
</div>
</div>
<div id="310be1b2-b18f-4798-8bae-6ca8e6f6bd10" class="cell" data-execution_count="118">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(xs.columns), <span class="bu">len</span>(xs_final.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>(135, 27)</code></pre>
</div>
</div>
<p>By focusing on the strongest predictors and removing redundancy, we can use just 27 features while substantially improving performance. Simpifying the model this way makes it easier to understand and maintain.</p>
</section>
<section id="partial-dependence-analysis" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="partial-dependence-analysis"><span class="header-section-number">6</span> Partial dependence analysis</h2>
<p>We saw that the top two predictors were <code>log_installed_capacity</code> and <code>is_consumption</code>. Let’s examine how they vary with the target.</p>
<p>It’s worth looking at their value distributions. Here’s <code>log_installed_capacity</code>’s histogram:</p>
<div id="997f7056-1385-47c2-a03b-2b6ce8ac76df" class="cell" data-execution_count="119">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>valid_xs_final[<span class="st">'log_installed_capacity'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="enefit-1_files/figure-html/cell-79-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Most of the values are between 5.5 and 8.</p>
<p>Since <code>is_consumption</code> is categorical, we’ll get its value counts:</p>
<div id="c11f4402-dc99-4b9d-86a7-901980a8929a" class="cell" data-execution_count="120">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>valid_xs_final[<span class="st">'is_consumption'</span>].value_counts(sort<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>1    44904
2    44904
Name: is_consumption, dtype: int64</code></pre>
</div>
</div>
<p>There are as many production targets as consumption targets.</p>
<div id="cell-fig-partial-dependence" class="cell" data-execution_count="121">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> partial_dependence</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>fig,ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>PartialDependenceDisplay.from_estimator(m, valid_xs_final, [<span class="st">'log_installed_capacity'</span>, <span class="st">'is_consumption'</span>], </span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>                                        grid_resolution<span class="op">=</span><span class="dv">40</span>, ax<span class="op">=</span>ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-partial-dependence" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-partial-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-partial-dependence-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-partial-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Partial dependence plots of the 2 strongest predictors
</figcaption>
</figure>
</div>
</div>
</div>
<p>The plots in <a href="#fig-partial-dependence" class="quarto-xref">Figure&nbsp;5</a> show how <code>log_installed_capacity</code> and <code>is_consumption</code> vary with the target all else being equal. This isn’t as straightforward as averaging the targets for each unique value. Instead, we copy the dataset and fix the values in <code>log_installed_capacity</code> to one of its represented values. We get the predictions on this made-up version and average them. This is repeated until we cover all values <code>log_installed_capacity</code> has taken in dataset. The plot above shows the average prediction vs <code>log_installed_capacity</code>’s such fixed values.</p>
<p>As we might expect, greater installed capacity correlates to higher production or consumption amounts. Between 5.5 and 8 (the bulk of the data), the target appears linearly related with <code>log_installed_capacity</code>, which means it’s exponentially related with the raw <code>installed_capacity</code>. There’s a dramatic jump after 8, likely from those infrequent but large values seen in our earlier analysis.</p>
<p>The <code>is_consumption</code> plot suggests that consumption amounts are significantly higher than production amounts, which matches what we saw with <code>dtreeviz</code>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>As yet, there doesn’t seem to be any data leakage, where the training data includes information that wouldn’t be available at test time. We’d normally be alerted to the possibility by performance that appears too good to be true, seemingly meaningless features that turn out to be strong predictors, or partial dependence plots that don’t match our intuition.</p>
</div>
</div>
</section>
<section id="out-of-domain-analysis" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="out-of-domain-analysis"><span class="header-section-number">7</span> Out-of-Domain analysis</h2>
<p>Domain shift is expected since the data are time series, but it’s still worth looking at closer. We want to evaluate the extent of domain shift for each feature. Conveniently, we can do that with a random forest!</p>
<p>First, we’ll re-label the data such that the model learns to predict whether a row belongs to the training or validation set and then look at its feature importances:</p>
<div id="d324f56e-70a1-4d47-bef2-46e157c91a47" class="cell" data-execution_count="122">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>df_dom <span class="op">=</span> pd.concat([xs_final, valid_xs_final])</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>is_valid <span class="op">=</span> np.array([<span class="dv">0</span>]<span class="op">*</span><span class="bu">len</span>(xs_final) <span class="op">+</span> [<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(valid_xs_final))</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>m_dom <span class="op">=</span> rf(df_dom, is_valid)</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>rf_feat_importance(m_dom, df_dom)[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 3 µs, sys: 0 ns, total: 3 µs
Wall time: 6.91 µs</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="122">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cols</th>
<th data-quarto-table-cell-role="th">imp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>datetimeElapsed</td>
<td>0.813972</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>datetimeDayofyear</td>
<td>0.068870</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17</td>
<td>datetimeWeek</td>
<td>0.044067</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>sin(datetimeDayofyear)</td>
<td>0.042158</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>log_shortwave_radiation_mean_hd</td>
<td>0.007305</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>log_diffuse_radiation_mean_hd</td>
<td>0.006550</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>cos(datetimeHour)</td>
<td>0.005165</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>log_snowfall_std_fd</td>
<td>0.003465</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11</td>
<td>temperature_mean_hd</td>
<td>0.003244</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>log_direct_solar_radiation_mean_hd</td>
<td>0.002117</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>As expected, features that directly encode the date or measure weather conditions exhibit domain shift. <code>datetimeElapsed</code> shifts the most since it is incremented most frequently. <code>datetimeDayofyear</code> and <code>datetimeWeek</code> increment less frequently and within a narrower range of values, so it makes sense why they shift less.</p>
<p>Let’s see whether removing columns with high domain shift (i.e.&nbsp;an importance score &gt; 0.01) helps. We’ll remove the columns one at a time and check the validation error:</p>
<div id="00922f83-6122-4eef-b7c5-6ad7a0ec5493" class="cell" data-execution_count="123">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs_final, y)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'baseline'</span>, m_mae(m, valid_xs_final, valid_y))</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> (<span class="st">'datetimeElapsed'</span>, <span class="st">'datetimeDayofyear'</span>, <span class="st">'sin(datetimeDayofyear)'</span>, <span class="st">'datetimeWeek'</span>):</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> rf(xs_final.drop(c,axis<span class="op">=</span><span class="dv">1</span>), y)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(c, m_mae(m, valid_xs_final.drop(c,axis<span class="op">=</span><span class="dv">1</span>), valid_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>baseline 48.669705
datetimeElapsed 50.178429
datetimeDayofyear 47.093186
sin(datetimeDayofyear) 46.950955
datetimeWeek 47.002353
CPU times: user 46min 32s, sys: 8.86 s, total: 46min 41s
Wall time: 9min 5s</code></pre>
</div>
</div>
<p>Looks like we can drop <code>datetimeDayofyear</code>, <code>sin(datetimeDayofyear)</code>, and <code>datetimeWeek</code> safely. Let’s see:</p>
<div id="12e9957d-4c5e-4b96-ab82-82db848ecaf4" class="cell" data-execution_count="125">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>time_vars <span class="op">=</span> [<span class="st">'datetimeDayofyear'</span>, <span class="st">'sin(datetimeDayofyear)'</span>, <span class="st">'datetimeWeek'</span>]</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>xs_final_time <span class="op">=</span> xs_final.drop(time_vars, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>valid_xs_time <span class="op">=</span> valid_xs_final.drop(time_vars, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs_final_time, y)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs_final_time, y))</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs_time, valid_y))</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB error: "</span>, mae(m.oob_prediction_, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  18.6872
valid mae:  48.099852
OOB error:  23.626528
CPU times: user 7min 2s, sys: 1.87 s, total: 7min 3s
Wall time: 1min 23s</code></pre>
</div>
</div>
<p>Looking good. Removing columns with high domain shift will make the model more resilient.</p>
<p>Lastly, it may help to not use old data. Let’s see whether dropping data prior to Jan 2022 helps:</p>
<div id="c4d85c3a-c1de-4302-84b0-7676b847b7c5" class="cell" data-execution_count="126">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> xs[<span class="st">'datetimeYear'</span>]<span class="op">&gt;</span><span class="dv">1</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>xs_filt <span class="op">=</span> xs_final_time[filt]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>y_filt <span class="op">=</span> y[filt]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="076c423d-d982-4624-a103-c5eb12eeed4c" class="cell" data-execution_count="127">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> rf(xs_filt, y_filt)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m, xs_filt, y_filt))</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m, valid_xs_time, valid_y))</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB error: "</span>, mae(m.oob_prediction_, y_filt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  19.664996
valid mae:  50.463263
OOB error:  24.873183
CPU times: user 5min 9s, sys: 447 ms, total: 5min 10s
Wall time: 1min 1s</code></pre>
</div>
</div>
<div id="0cf0984a-b4a3-45d1-83ef-5b374aaecf82" class="cell" data-execution_count="128">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(xs.columns), <span class="bu">len</span>(xs_filt.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>(135, 24)</code></pre>
</div>
</div>
<div id="d4a56d06-96f4-47ba-ab73-575a0de91f19" class="cell" data-execution_count="129">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(xs), <span class="bu">len</span>(xs_filt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>(1531020, 1188514)</code></pre>
</div>
</div>
<p>Dropping the older data means we need 22% fewer records to train, but since we didn’t improve, we’ll proceed with the whole dataset.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our original random forest had a 57.4 validation error using 135 features. Our simplified model achieves a 48.1 validation error using just 18% of the features!</p>
</div>
</div>
</section>
<section id="tree-interpreter" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="tree-interpreter"><span class="header-section-number">8</span> Tree interpreter</h2>
<p>With the <code>treeinterpreter</code> and <code>waterfallcharts</code> libraries, we can visualize how single predictions are made.</p>
<div id="185a861d-921f-4e2f-9d68-982deb794a0f" class="cell" data-execution_count="130">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> treeinterpreter <span class="im">import</span> treeinterpreter</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> waterfall_chart <span class="im">import</span> plot <span class="im">as</span> waterfall</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s grab the first few rows of the validation set and get predictions:</p>
<div id="d360363c-38ea-4da4-8253-e66524d2ea80" class="cell" data-execution_count="131">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>row <span class="op">=</span> valid_xs_time.iloc[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="68157cc0-6097-4e4f-a023-53706d8b1a2a" class="cell" data-execution_count="132">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>prediction,bias,contributions <span class="op">=</span> treeinterpreter.predict(m, row.values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Just as we looked at feature importances over the entire dataset, we can do so for a single row. Let’s check out the first row:</p>
<div id="2d761392-48e5-45f9-96c1-533cdb349cf1" class="cell" data-execution_count="135">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">'prediction'</span>: prediction[<span class="dv">0</span>], </span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'bias'</span>: bias[<span class="dv">0</span>],</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'contributions_sum'</span>: contributions[<span class="dv">0</span>].<span class="bu">sum</span>()}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>{'prediction': array([4.77301322]),
 'bias': 261.68865324823906,
 'contributions_sum': -256.91564002804654}</code></pre>
</div>
</div>
<div id="08a09b8e-b969-419b-b6cf-73ae4f0c5d16" class="cell" data-execution_count="136">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>bias[<span class="dv">0</span>] <span class="op">+</span> contributions[<span class="dv">0</span>].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>4.773013220192524</code></pre>
</div>
</div>
<p>The prediction is obtained by adding the bias and the contributions’ sum. The bias is the dependent variable’s mean, i.e.&nbsp;the “model” at every tree’s root node. The contributions’ sum indicates the total change in the prediction, which we can visualize with a waterfall chart:</p>
<div id="cell-fig-tree-interp" class="cell" data-execution_count="150">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>waterfall(valid_xs_time.columns, contributions[<span class="dv">0</span>], threshold<span class="op">=</span><span class="fl">0.175</span>, </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>          rotation_value<span class="op">=</span><span class="dv">35</span>,formatting<span class="op">=</span><span class="st">'</span><span class="sc">{:,.2f}</span><span class="st">'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-tree-interp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tree-interp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="enefit-1_files/figure-html/fig-tree-interp-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tree-interp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Plotting feature contributions for a single example
</figcaption>
</figure>
</div>
</div>
</div>
<p>Here’s the row with the most influential columns:</p>
<div id="36f307fd-2586-4d3e-b1bd-ccf26342718a" class="cell" data-execution_count="151">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>valid_xs_time[:<span class="dv">1</span>][[<span class="st">'is_consumption'</span>, <span class="st">'log_eic_count'</span>, <span class="st">'is_business'</span>, <span class="st">'county'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="151">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">log_eic_count</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">county</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1531020</td>
<td>1</td>
<td>5.961005</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>This row shows a production target for a non-business prosumer in Harjumaa. We can see how each feature influenced the prediction–starting from 0–with the overall change shown in net. The contributions of less influential columns are grouped together in “other”.</p>
<p>We haven’t yet considered random forests’ major limitation: their inability to extrapolate. A random forest consists of decision trees whose predictions are just the targets’ average value in a leaf node. Therefore, the trees (and hence the forest) can’t predict values outside the training data’s range! We may be able to alleviate the issue with a neural network.</p>
</section>
<section id="modeling-with-a-neural-network" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="modeling-with-a-neural-network"><span class="header-section-number">9</span> Modeling with a neural network</h2>
<p>We’ll start by setting up a <code>TabularPandas</code> object with the trimmed feature set.</p>
<div id="dc7127e9-eda7-4f9f-85a6-fcbf734aab30" class="cell" data-execution_count="152">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> random</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>is_partial <span class="op">=</span> <span class="va">False</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>eval_month <span class="op">=</span> <span class="st">'feb23'</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify, Normalize]</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>max_card <span class="op">=</span> <span class="dv">9000</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="co"># need ['datetime', 'row_id'] for the splits, which are not in the final feature set. Dropped afterward. </span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>to_nn, final_splits <span class="op">=</span> setup_training(is_partial, </span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>                                     features_df[<span class="bu">list</span>(xs_final_time.columns) <span class="op">+</span> [<span class="st">'datetime'</span>, <span class="st">'row_id'</span>, dep_var]], </span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>                                     pid_lookup_df, </span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>                                     eval_month, </span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>                                     procs, </span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>                                     max_card)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>n_pids_dropped from train: 4
pids_dropped from train: [14, 60, 20, 23]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that we dropped a random set of prosumers among those common to both training and validation after the split, making the validation ones new from the model’s point of view. Re-setting the random seed ensures we drop the same set of prosumers as we did earlier.</p>
</div>
</div>
<p>When a <code>TabularPandas</code> is set up, <code>fastai</code> has to decide which variables are continuous and which are categorical. The function <code>cont_cat_split</code> makes this decision based on a variable’s cardinality–how many unique values it takes–and a <code>max_card</code> parameter. If the cardinality exceeds <code>max_card</code> or the variable is a float type, it’s treated as continuous. If it’s cardinality is less than <code>max_card</code>, it’s categorical. Let’s check that it worked correctly:</p>
<div id="37218611-3ef8-4227-afb0-43249c205ff8" class="cell" data-execution_count="153">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>to_nn.cont_names.remove(<span class="st">'row_id'</span>)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>to_nn.cat_names.remove(<span class="st">'datetime'</span>)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>{<span class="st">'cont_names'</span>: <span class="bu">list</span>(to_nn.cont_names), </span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'cat_names'</span>: <span class="bu">list</span>(to_nn.cat_names)</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>{'cont_names': ['log_installed_capacity',
  'log_eic_count',
  'log_surface_solar_radiation_downwards_mean_fd',
  'log_shortwave_radiation_mean_hd',
  'temperature_mean_hd',
  'log_direct_solar_radiation_mean_hd',
  'datetimeElapsed',
  'log_surface_solar_radiation_downwards_std_fd',
  'log_direct_solar_radiation_mean_fd',
  'log_surface_solar_radiation_downwards_mean_fl',
  'log_diffuse_radiation_mean_hd',
  'log_windspeed_10m_std_hl',
  'log_snowfall_std_fd',
  'log_direct_solar_radiation_std_fd',
  'cos(datetimeHour)',
  'cloudcover_low_mean_fd',
  'log_shortwave_radiation_mean_hl'],
 'cat_names': ['is_consumption',
  'is_business',
  'product_type',
  'county',
  'datetimeHour',
  'is_weekend',
  'datetimeDayofweek']}</code></pre>
</div>
</div>
<p>Looks good. Now we’ll train the network.</p>
<div id="2347f7dc-0012-41d9-9894-f71c3c00d851" class="cell" data-execution_count="154">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nn_mae(preds, y): <span class="cf">return</span> torch.<span class="bu">round</span>((preds <span class="op">-</span> y).<span class="bu">abs</span>().mean(), decimals<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since tabular models and datasets have a relatively low memory footprint, we can use larger batch sizes than <code>fastai</code>’s default (64):</p>
<div id="a23861fb-4d43-4a89-b186-597b3908377d" class="cell" data-execution_count="155">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> to_nn.dataloaders(bs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="9b36df3c-8f6e-4900-b61b-331b1a1c826f" class="cell" data-execution_count="156">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> to_nn.train.y</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>y.<span class="bu">min</span>(),y.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="156">
<pre><code>(0.0, 15480.274)</code></pre>
</div>
</div>
<div id="036057bc-8023-45bf-a063-fd77111c613e" class="cell" data-execution_count="157">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>y_max_factor <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>np.ceil(y_max_factor<span class="op">*</span>y.<span class="bu">max</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="157">
<pre><code>46441.0</code></pre>
</div>
</div>
<div id="95e7e57f-f8d7-4c01-b05f-bc57210a96a2" class="cell" data-execution_count="197">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>y_max <span class="op">=</span> np.ceil(y_max_factor<span class="op">*</span>y.<span class="bu">max</span>())</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>layers <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">500</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2357dcb8-0613-4cf4-8aae-058602b81234" class="cell" data-execution_count="198">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(<span class="dv">0</span>, y_max), layers<span class="op">=</span>layers,</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.l1_loss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We know the target will always greater than or equal to 0, but a neural network can produce negative outputs. We can configure our <code>tabular_learner</code>’s sigmoid function with <code>y_range</code> to constrain its output values between 0 and some maximum. This will help stabilize training without overly compromising extrapolation flexibility. For now, I set the maximum to 3x the maximum target in the training set.</p>
<p>The default <code>tabular_learner</code> has 2 hidden layers, with 200 and 100 activations, respectively, which works well for small datasets. With some fiddling, I found increasing the layer sizes to 1000 and 500 activations to work reasonably well.</p>
<p>To help set a learning rate, <code>fastai</code> provides a handy learning rate finder:</p>
<div id="8df5554d-1107-4d56-a889-ff26c46ae8df" class="cell" data-execution_count="199">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find(suggest_funcs<span class="op">=</span>[slide, valley])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="199">
<pre><code>SuggestedLRs(slide=6.309573450380412e-07, valley=0.001737800776027143)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="enefit-1_files/figure-html/cell-104-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We’ll use a 1e-3 learning rate and train for a few epochs:</p>
<div id="90bc3dac-98b4-49cb-8517-da20f7449db5" class="cell" data-execution_count="200">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>137.240952</td>
<td>139.941147</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>1</td>
<td>68.864647</td>
<td>82.996590</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>2</td>
<td>53.926590</td>
<td>73.568031</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>3</td>
<td>45.439701</td>
<td>70.161186</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>4</td>
<td>41.196339</td>
<td>64.239616</td>
<td>00:18</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Let’s see some predictions (scroll to the right end):</p>
<div id="6f2d88e4-e7aa-4920-8670-3e66ee0aa1c7" class="cell" data-execution_count="201">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">is_consumption</th>
<th data-quarto-table-cell-role="th">is_business</th>
<th data-quarto-table-cell-role="th">product_type</th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">datetimeHour</th>
<th data-quarto-table-cell-role="th">is_weekend</th>
<th data-quarto-table-cell-role="th">datetimeDayofweek</th>
<th data-quarto-table-cell-role="th">log_installed_capacity</th>
<th data-quarto-table-cell-role="th">log_eic_count</th>
<th data-quarto-table-cell-role="th">log_surface_solar_radiation_downwards_mean_fd</th>
<th data-quarto-table-cell-role="th">log_shortwave_radiation_mean_hd</th>
<th data-quarto-table-cell-role="th">temperature_mean_hd</th>
<th data-quarto-table-cell-role="th">log_direct_solar_radiation_mean_hd</th>
<th data-quarto-table-cell-role="th">datetimeElapsed</th>
<th data-quarto-table-cell-role="th">log_surface_solar_radiation_downwards_std_fd</th>
<th data-quarto-table-cell-role="th">log_direct_solar_radiation_mean_fd</th>
<th data-quarto-table-cell-role="th">log_surface_solar_radiation_downwards_mean_fl</th>
<th data-quarto-table-cell-role="th">log_diffuse_radiation_mean_hd</th>
<th data-quarto-table-cell-role="th">log_windspeed_10m_std_hl</th>
<th data-quarto-table-cell-role="th">log_snowfall_std_fd</th>
<th data-quarto-table-cell-role="th">log_direct_solar_radiation_std_fd</th>
<th data-quarto-table-cell-role="th">cos(datetimeHour)</th>
<th data-quarto-table-cell-role="th">cloudcover_low_mean_fd</th>
<th data-quarto-table-cell-role="th">log_shortwave_radiation_mean_hl</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">target_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.0</td>
<td>2.0</td>
<td>4.0</td>
<td>5.0</td>
<td>18.0</td>
<td>1.0</td>
<td>4.0</td>
<td>0.651592</td>
<td>0.222225</td>
<td>-0.889688</td>
<td>-0.111235</td>
<td>-0.893069</td>
<td>-0.406757</td>
<td>1.741631</td>
<td>-0.816057</td>
<td>-0.827848</td>
<td>-0.548966</td>
<td>-0.069316</td>
<td>-0.374684</td>
<td>0.794611</td>
<td>-0.751869</td>
<td>-1.365782</td>
<td>1.519243</td>
<td>-0.549535</td>
<td>988.713989</td>
<td>1015.745361</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.0</td>
<td>2.0</td>
<td>4.0</td>
<td>12.0</td>
<td>21.0</td>
<td>1.0</td>
<td>1.0</td>
<td>2.135026</td>
<td>1.542524</td>
<td>-0.889688</td>
<td>-0.915917</td>
<td>-0.953018</td>
<td>-0.774304</td>
<td>1.769509</td>
<td>-0.816057</td>
<td>-0.827848</td>
<td>-0.548966</td>
<td>-0.932073</td>
<td>0.081468</td>
<td>-0.382855</td>
<td>-0.751869</td>
<td>-1.224502</td>
<td>-0.978829</td>
<td>-0.549535</td>
<td>14.080000</td>
<td>4.172789</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>3.0</td>
<td>11.0</td>
<td>1.0</td>
<td>2.0</td>
<td>-1.226182</td>
<td>-1.027644</td>
<td>1.259645</td>
<td>1.164032</td>
<td>-0.520550</td>
<td>1.319541</td>
<td>1.915397</td>
<td>0.696772</td>
<td>1.169106</td>
<td>-0.548966</td>
<td>1.129292</td>
<td>-0.374684</td>
<td>0.514093</td>
<td>1.834087</td>
<td>0.707350</td>
<td>0.014958</td>
<td>-0.549535</td>
<td>100.364998</td>
<td>58.802540</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.0</td>
<td>2.0</td>
<td>2.0</td>
<td>6.0</td>
<td>15.0</td>
<td>1.0</td>
<td>2.0</td>
<td>-0.368409</td>
<td>-0.549235</td>
<td>1.065332</td>
<td>1.023860</td>
<td>-0.763749</td>
<td>0.425499</td>
<td>1.774586</td>
<td>0.386823</td>
<td>1.212754</td>
<td>-0.548966</td>
<td>1.260255</td>
<td>-0.374684</td>
<td>-0.392570</td>
<td>0.725691</td>
<td>-0.706864</td>
<td>0.020374</td>
<td>-0.549535</td>
<td>8.256000</td>
<td>5.093526</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1.0</td>
<td>1.0</td>
<td>2.0</td>
<td>2.0</td>
<td>8.0</td>
<td>1.0</td>
<td>4.0</td>
<td>-1.622382</td>
<td>-0.863264</td>
<td>-0.402592</td>
<td>-0.906819</td>
<td>-1.874382</td>
<td>-0.774304</td>
<td>1.880760</td>
<td>2.362028</td>
<td>-0.511674</td>
<td>-0.548966</td>
<td>-0.921395</td>
<td>-0.374684</td>
<td>-0.257821</td>
<td>0.544251</td>
<td>1.366268</td>
<td>0.607579</td>
<td>-0.549535</td>
<td>0.000000</td>
<td>0.260096</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1.0</td>
<td>1.0</td>
<td>4.0</td>
<td>16.0</td>
<td>21.0</td>
<td>1.0</td>
<td>1.0</td>
<td>0.786952</td>
<td>1.249527</td>
<td>-0.889688</td>
<td>-0.915917</td>
<td>-0.953018</td>
<td>-0.774304</td>
<td>1.769509</td>
<td>-0.816057</td>
<td>-0.827848</td>
<td>-0.548966</td>
<td>-0.932073</td>
<td>1.489535</td>
<td>-0.382855</td>
<td>-0.751869</td>
<td>-1.224502</td>
<td>-0.978829</td>
<td>-0.549535</td>
<td>2.062000</td>
<td>2.446304</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1.0</td>
<td>2.0</td>
<td>2.0</td>
<td>8.0</td>
<td>18.0</td>
<td>1.0</td>
<td>4.0</td>
<td>0.846031</td>
<td>-0.316779</td>
<td>-0.350409</td>
<td>0.515269</td>
<td>-1.241519</td>
<td>-0.750921</td>
<td>1.883574</td>
<td>0.927771</td>
<td>-0.816394</td>
<td>0.182545</td>
<td>0.746684</td>
<td>0.379540</td>
<td>0.798027</td>
<td>-0.468421</td>
<td>-1.365782</td>
<td>-0.063459</td>
<td>1.197275</td>
<td>0.006000</td>
<td>2.152201</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2.0</td>
<td>2.0</td>
<td>1.0</td>
<td>8.0</td>
<td>23.0</td>
<td>1.0</td>
<td>2.0</td>
<td>0.642359</td>
<td>-0.941713</td>
<td>-0.889688</td>
<td>-0.915917</td>
<td>-0.845383</td>
<td>-0.774304</td>
<td>1.918782</td>
<td>-0.816057</td>
<td>-0.827848</td>
<td>-0.548966</td>
<td>-0.932073</td>
<td>-0.099291</td>
<td>-0.401721</td>
<td>-0.751869</td>
<td>-0.706864</td>
<td>-1.217128</td>
<td>-0.549535</td>
<td>319.354004</td>
<td>333.857758</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>3.0</td>
<td>3.0</td>
<td>1.0</td>
<td>1.0</td>
<td>-1.226182</td>
<td>-1.027644</td>
<td>-0.889688</td>
<td>-0.896151</td>
<td>-0.589241</td>
<td>-0.774304</td>
<td>1.811756</td>
<td>-0.816057</td>
<td>-0.827848</td>
<td>-0.548966</td>
<td>-0.908876</td>
<td>-0.374684</td>
<td>-0.401721</td>
<td>-0.751869</td>
<td>0.707350</td>
<td>-0.945936</td>
<td>-0.549535</td>
<td>69.614998</td>
<td>48.941792</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>These look reasonable. Let’s train a few more epochs:</p>
<div id="877b4023-7f91-4561-a199-fda14d09ff18" class="cell" data-execution_count="202">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(<span class="dv">0</span>, y_max), layers<span class="op">=</span>layers,</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.l1_loss)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>205.164886</td>
<td>225.064117</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>1</td>
<td>81.528191</td>
<td>117.643929</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>2</td>
<td>63.708591</td>
<td>81.429329</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>3</td>
<td>49.116337</td>
<td>72.492241</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>4</td>
<td>46.471172</td>
<td>72.559464</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>5</td>
<td>41.819759</td>
<td>66.305519</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>6</td>
<td>36.052628</td>
<td>68.395958</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>7</td>
<td>35.152107</td>
<td>65.868759</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>33.466084</td>
<td>65.284027</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>9</td>
<td>32.789875</td>
<td>65.576210</td>
<td>00:19</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="709acf35-1e40-4210-9e98-f191b8755f63" class="cell" data-execution_count="203">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds()</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"nn valid mae: "</span>, nn_mae(preds, targs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>nn valid mae:  tensor(65.5762)</code></pre>
</div>
</div>
<p>The neural net didn’t beat our random forest’s 48.1 error, but this isn’t too surprising. Unless a tabular dataset contains lots of high cardinality columns or unstructured data like natural language, neural networks don’t always offer great boosts in accuracy compared to decision tree ensembles. Neither case applies to this dataset; there’s no unstructured data, and no high cardinalities:</p>
<div id="fcd6bd52-c267-4ee4-8cb5-2b8ed897b97d" class="cell" data-execution_count="204">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>to_nn[to_nn.cat_names].nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="204">
<pre><code>is_consumption        2
is_business           2
product_type          4
county               16
datetimeHour         24
is_weekend            2
datetimeDayofweek     7
dtype: int64</code></pre>
</div>
</div>
<p>Let’s see if ensembling can take us further.</p>
</section>
<section id="ensembling" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="ensembling"><span class="header-section-number">10</span> Ensembling</h2>
<p>Earlier, we discussed bagging as a technique to ensemble decision trees. The premise was that uncorrelated models will have uncorrelated errors, and the average of those uncorrelated errors will tend to 0. In random forests, uncorrelated errors are achieved by training the constitutent trees with random subsets of the data. However, we can get similarly uncorrelated errors by combining models that are trained using very different algorithms, as are random forests and neural networks.</p>
<p>Ensembling our random forest and neural network is easy–we just average their predictions:</p>
<div id="11f6500b-6a1e-4d8f-906f-7a75b61ae34e" class="cell" data-execution_count="205">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="op">=</span> m.predict(valid_xs_time)</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>ens_preds <span class="op">=</span> (to_np(preds.squeeze()) <span class="op">+</span> rf_preds) <span class="op">/</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s check the error:</p>
<div id="63e11565-4d4a-4b4b-9c01-461810b1aed6" class="cell" data-execution_count="206">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>(ens_preds <span class="op">-</span> valid_y).<span class="bu">abs</span>().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="206">
<pre><code>50.5425989624969</code></pre>
</div>
</div>
<p>No dice this time, but we may yet improve by experimenting with the hyperparameters.</p>
</section>
<section id="entity-embeddings-in-a-random-forest" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="entity-embeddings-in-a-random-forest"><span class="header-section-number">11</span> Entity embeddings in a random forest</h2>
<p>We saw a tradeoff with neural networks: gains in extrapolation and potentially accuracy, but fiddly training.</p>
<p>In the paper <a href="https://arxiv.org/abs/1604.06737">“Entity Embeddings of Categorical Variables”</a>, authors Guo and Berkman show how the embeddings of categorical variables can be used in a random forest. In this way, we gain much of a neural network’s performance improvement without actually using one at inference time! The process is simple: train a neural network with categorical embeddings, concatenate the learned embeddings with the continuous columns, and then train our random forest.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In entity embedding, categorical variables’ distinct values–the categories–are allotted their own set of initially random numbers (“latent factors”). An embedding is just a lookup table that maps the categories to their latent factors. So, to “embed” a category is to look up its latent factors.</p>
<p>In the data, a categorical variables’ original values are replaced with where to find their latent factors in the embedding. As we’ve seen, this is how <code>TabularPandas</code> encoded <code>is_consumption</code>. It’s original values–0 and 1–were replaced with 1 and 2, respectively. In the embedding, the latent factors for 0 and 1 are found at positions 1 and 2, respectively. This is why 1 and 2 have no particular meaning outside of this lookup operation.</p>
<p>In a neural network, an embedding is just another layer. The latent factors within it are gradually adjusted during training and eventually approach values that capture meaningful aspects of the categories. The neural network only has to be trained once; we can store the embeddings and re-use them in other models.</p>
</div>
</div>
<p><code>tabular_learner</code> already uses entity embedding to handle categorical variables, so we can just get its learned embeddings. The <code>embed_features</code> function below prepares the data:</p>
<div id="271abeac-ffe4-473a-93fc-2de3ed4c475b" class="cell" data-execution_count="207">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> embed_features(learner, xs):</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># deep copy (creates new object w/ a copy of indices and data of original)</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> xs.copy()</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(learn.dls.cat_names):</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the embedding (move it to CPU first)</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># .cpu() see nn.ModuleList.cpu?</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for learn.model.embeds, see learn.model??</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>        emb <span class="op">=</span> learn.model.embeds[i].cpu()</span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># embed the categorical feature and return a df using the indices of xs</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for embedding_dim see nn.Embedding??</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># join previously failed b/c col names overlap for each embedding feature</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># they were previously all to be named feature_0, feature_1, etc.</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>        new_feat <span class="op">=</span> pd.DataFrame(emb(tensor(xs[feature], dtype<span class="op">=</span>torch.int64)), </span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>                                index<span class="op">=</span>xs.index, </span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>                                columns<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(emb.embedding_dim)])</span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># drop the categorical feature</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>        xs.drop(columns<span class="op">=</span>feature, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># left join the embedded features w/ xs</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># returns nn's cat embeddings concatenated w/ original cont variables</span></span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the cont variables will be the same for the rf and the nn</span></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>        xs <span class="op">=</span> xs.join(new_feat)</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1fb8463d-5e10-49f9-ad52-fdaa8b65cc3b" class="cell" data-execution_count="208">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>embedded_xs <span class="op">=</span> embed_features(learn, learn.dls.train.xs)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>embedded_valid_xs <span class="op">=</span> embed_features(learn, learn.dls.valid.xs)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>embedded_xs.shape, embedded_valid_xs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="208">
<pre><code>((1531020, 53), (89808, 53))</code></pre>
</div>
</div>
<div id="8de4ebd8-5ca5-4e70-99d6-611650476549" class="cell" data-execution_count="209">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>embedded_xs.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="209">
<pre><code>Index(['log_installed_capacity', 'log_eic_count',
       'log_surface_solar_radiation_downwards_mean_fd',
       'log_shortwave_radiation_mean_hd', 'temperature_mean_hd',
       'log_direct_solar_radiation_mean_hd', 'datetimeElapsed',
       'log_surface_solar_radiation_downwards_std_fd',
       'log_direct_solar_radiation_mean_fd',
       'log_surface_solar_radiation_downwards_mean_fl',
       'log_diffuse_radiation_mean_hd', 'log_windspeed_10m_std_hl',
       'log_snowfall_std_fd', 'log_direct_solar_radiation_std_fd',
       'cos(datetimeHour)', 'cloudcover_low_mean_fd',
       'log_shortwave_radiation_mean_hl', 'is_consumption_0',
       'is_consumption_1', 'is_consumption_2', 'is_business_0',
       'is_business_1', 'is_business_2', 'product_type_0', 'product_type_1',
       'product_type_2', 'product_type_3', 'county_0', 'county_1', 'county_2',
       'county_3', 'county_4', 'county_5', 'county_6', 'county_7',
       'datetimeHour_0', 'datetimeHour_1', 'datetimeHour_2', 'datetimeHour_3',
       'datetimeHour_4', 'datetimeHour_5', 'datetimeHour_6', 'datetimeHour_7',
       'datetimeHour_8', 'datetimeHour_9', 'is_weekend_0', 'is_weekend_1',
       'is_weekend_2', 'datetimeDayofweek_0', 'datetimeDayofweek_1',
       'datetimeDayofweek_2', 'datetimeDayofweek_3', 'datetimeDayofweek_4'],
      dtype='object')</code></pre>
</div>
</div>
<p>Let’s see how we do:</p>
<div id="00380a9d-6721-43b8-836d-8d90d58a15e1" class="cell" data-execution_count="210">
<details open="" class="code-fold">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>m_cat_emb <span class="op">=</span> rf(embedded_xs, y)</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pass m_cat_emb for the model. includes both cont variables and nn's cat embeddings</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pass the embedded xs for both train and valid errors</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"train mae: "</span>, m_mae(m_cat_emb, embedded_xs, y))</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"valid mae: "</span>, m_mae(m_cat_emb, embedded_valid_xs, valid_y))</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OOB mae: "</span>, mae(m_cat_emb.oob_prediction_, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train mae:  18.011094
valid mae:  46.230781
OOB mae:  22.948394
CPU times: user 10min 40s, sys: 4 s, total: 10min 44s
Wall time: 2min 10s</code></pre>
</div>
</div>
<p>Nice, that’s our best result yet!</p>
</section>
<section id="next-steps" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">12</span> Next steps</h2>
<p>In the next post, we’ll examine production and consumption more closely and see whether modeling them separately gives better results than modeling them together. In addition, we’ll engineer lagged features and streamline the data processing pipeline.</p>
<p>Thanks for reading!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/sksant\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>